<main class="container">
  <!-- Breadcrumb -->
  <nav aria-label="breadcrumb" id="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a routerLink="/admin">Administration</a></li>
      <li class="breadcrumb-item"><a routerLink="/admin/customer-accounts">Customer Accounts</a></li>
      <li class="breadcrumb-item active">{{isViewMode ? 'View' : (isEditMode ? 'Update' : 'Create')}}</li>
    </ol>
  </nav>

  <!-- Header -->
  <h3>{{isViewMode ? 'View' : (isEditMode ? 'Update' : 'Create')}} Customer Account</h3>

  <!-- Loading Indicator -->
  <div *ngIf="loading" class="text-center my-4">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- Error Message -->
  <div *ngIf="error" class="alert alert-danger">{{error}}</div>
  <div *ngIf="successMessage" class="alert alert-success">{{successMessage}}</div>

  <div class="row justify-content-center" *ngIf="!loading">
    <div class="col-6">
      <form [formGroup]="form" (ngSubmit)="onSubmit()">
        <div class="row g-3">

          <!-- Id (Read-only, shown only in edit/view mode) -->
          <div class="col-12" *ngIf="isEditMode || isViewMode">
            <label class="form-label">Id</label>
            <input
              type="text"
              class="form-control"
              [value]="account?.id"
              readonly
              disabled>
          </div>

          <div class="col-md-6">
            <label class="form-label">Member Account <span class="text-danger">*</span></label>
            <select class="form-select" formControlName="memberAccountId" [class.is-invalid]="isFieldInvalid('memberAccountId')">
              <option [ngValue]="null" disabled>Select member account</option>
              <option *ngFor="let m of members" [ngValue]="m.id">{{m.memberNumber}} - {{m.facilityName || m.memberAccountName || m.name}}</option>
            </select>
            <div class="invalid-feedback" *ngIf="isFieldInvalid('memberAccountId')">Member Account is required.</div>
          </div>
          <div class="col-md-6">
            <label class="form-label">Distributor <span class="text-danger">*</span></label>
            <select class="form-select" formControlName="distributorId" [class.is-invalid]="isFieldInvalid('distributorId')">
              <option [ngValue]="null" disabled>Select distributor</option>
              <option *ngFor="let d of distributors" [ngValue]="d.id">{{d.name}}</option>
            </select>
            <div class="invalid-feedback" *ngIf="isFieldInvalid('distributorId')">Distributor is required.</div>
          </div>

          <div class="col-md-6">
            <label class="form-label">Op-Co</label>
            <select class="form-select" formControlName="opCoId">
              <option [ngValue]="null">Select Op-Co (optional)</option>
              <option *ngFor="let o of opcos" [ngValue]="o.id">{{o.name}}</option>
            </select>
          </div>

          <div class="col-md-6">
            <label class="form-label">Status <span class="text-danger">*</span></label>
            <select class="form-select" formControlName="status" [class.is-invalid]="isFieldInvalid('status')">
              <option value="Active">Active</option>
              <option value="Inactive">Inactive</option>
              <option value="Pending">Pending</option>
              <option value="Suspended">Suspended</option>
              <option value="Closed">Closed</option>
              <option value="Billing">Billing</option>
              <option value="Test">Test</option>
              <option value="Prospect">Prospect</option>
              <option value="Rebate">Rebate</option>
              <option value="USDA">USDA</option>
            </select>
            <div class="invalid-feedback" *ngIf="isFieldInvalid('status')">Status is required.</div>
          </div>

          <div class="col-md-6">
            <label class="form-label">Customer Name <span class="text-danger">*</span></label>
            <input type="text" formControlName="customerName" class="form-control" [class.is-invalid]="isFieldInvalid('customerName')">
            <div class="invalid-feedback" *ngIf="isFieldInvalid('customerName')">Customer Name is required.</div>
          </div>
          <div class="col-md-6">
            <label class="form-label">Customer Account # <span class="text-danger">*</span></label>
            <input type="text" formControlName="customerAccountNumber" class="form-control" [class.is-invalid]="isFieldInvalid('customerAccountNumber')">
            <div class="invalid-feedback" *ngIf="isFieldInvalid('customerAccountNumber')">Customer Account # is required.</div>
          </div>


          <!-- Address fields hidden per user request -->
          <!-- <div class="col-12">
            <label class="form-label">Address</label>
            <input type="text" formControlName="address" class="form-control">
          </div>

          <div class="col-md-4">
            <label class="form-label">City</label>
            <input type="text" formControlName="city" class="form-control">
          </div>
          <div class="col-md-4">
            <label class="form-label">State</label>
            <select class="form-select" formControlName="state">
              <option value="">Select state</option>
              <option *ngFor="let state of usStates" [value]="state">{{state}}</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label">Zip Code</label>
            <input type="text" formControlName="zipCode" class="form-control">
          </div>

          <div class="col-md-6">
            <label class="form-label">Country</label>
            <input type="text" formControlName="country" class="form-control">
          </div> -->
          <!-- Phone field hidden per user request -->
          <!-- New Extended Fields -->
          <div class="col-md-6">
            <label class="form-label">Sales Rep</label>
            <input type="text" formControlName="salesRep" class="form-control">
          </div>
          <div class="col-md-6">
            <label class="form-label">DSO</label>
            <input type="text" formControlName="dso" class="form-control">
          </div>

          <div class="col-md-6">
            <label class="form-label">Start Date</label>
            <input type="date" formControlName="startDate" class="form-control" [class.has-value]="form.get('startDate')?.value">
          </div>
          <div class="col-md-6">
            <label class="form-label">End Date</label>
            <input type="date" formControlName="endDate" class="form-control" [class.has-value]="form.get('endDate')?.value">
          </div>

          <div class="col-md-6">
            <label class="form-label">TRACS Access <span class="text-danger">*</span></label>
            <select class="form-select" formControlName="tracsAccess" [class.is-invalid]="isFieldInvalid('tracsAccess')">
              <option [ngValue]="null" disabled>Select Yes/No</option>
              <option [ngValue]="true">Yes</option>
              <option [ngValue]="false">No</option>
            </select>
            <div class="invalid-feedback" *ngIf="isFieldInvalid('tracsAccess')">TRACS Access is required.</div>
          </div>
          <div class="col-md-6">
            <label class="form-label">Markup</label>
            <input type="text" class="form-control" formControlName="markup" maxlength="20" [class.is-invalid]="isFieldInvalid('markup')">
            <small class="form-text text-muted">Enter amount with $ or %</small>
            <div class="invalid-feedback" *ngIf="isFieldInvalid('markup')">Enter a valid markup (e.g., $5.00 or 3.25%).</div>
          </div>

          <div class="col-md-6">
            <label class="form-label">Audit Date</label>
            <input type="date" formControlName="auditDate" class="form-control" [class.has-value]="form.get('auditDate')?.value">
          </div>
          <div class="col-md-6">
            <label class="form-label">To Entegra</label>
            <select class="form-select" formControlName="toEntegra">
              <option [ngValue]="false">No</option>
              <option [ngValue]="true">Yes</option>
            </select>
          </div>

          <div class="col-md-6">
            <label class="form-label">Date To Entegra</label>
            <input type="date" formControlName="dateToEntegra" class="form-control" [class.has-value]="form.get('dateToEntegra')?.value">
          </div>
          <div class="col-md-6">
            <label class="form-label">Combined Unique ID</label>
            <input type="text" formControlName="combinedUniqueID" class="form-control">
          </div>

          <div class="col-md-6">
            <label class="form-label">Association</label>
            <select class="form-select" formControlName="association">
              <option [ngValue]="null">Select association</option>
              <option [ngValue]="1">CSN</option>
              <option [ngValue]="2">Combined</option>
              <option [ngValue]="3">RCDM</option>
              <option [ngValue]="4">SEMUPC</option>
            </select>
          </div>
          <!-- Email field hidden per user request -->

          <div class="col-12">
            <label class="form-label">Internal Notes</label>
            <textarea rows="3" formControlName="internalNotes" class="form-control"></textarea>
          </div>

        </div>

        <!-- Form Actions -->
        <div class="mt-4 d-flex justify-content-end">
          <!-- View Mode Actions -->
          <div *ngIf="isViewMode" class="d-flex">
            <button type="button" class="btn btn-denim me-2" (click)="onCancel()">
              Back to List
            </button>
            <button type="button" class="btn btn-denim" (click)="toggleEditMode()">
              <i class="fa-solid fa-pen me-2"></i>Edit
            </button>
          </div>

          <!-- Edit/Create Mode Actions -->
          <div *ngIf="!isViewMode" class="d-flex">
            <button type="button" class="btn btn-denim me-2" (click)="onCancel()">
              Cancel
            </button>
            <button type="submit" class="btn btn-denim" [disabled]="form.invalid || submitting">
              <span *ngIf="submitting" class="spinner-border spinner-border-sm me-2"></span>
              {{isEditMode ? 'Update' : 'Create'}} Customer Account
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
</main>

