<main class="container">
  <nav aria-label="breadcrumb" id="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a routerLink="/admin">Administration</a></li>
      <li class="breadcrumb-item"><a routerLink="/admin/member-accounts">Member Accounts</a></li>
      <li class="breadcrumb-item active">{{isViewMode ? 'View' : (isEditMode ? 'Update' : 'Create')}}</li>
    </ol>
  </nav>

  <h3>{{isViewMode ? 'View' : (isEditMode ? 'Update' : 'Create')}} Member Account</h3>

  <!-- Loading Indicator -->
  <div *ngIf="loading" class="text-center my-4">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <div *ngIf="error" class="alert alert-danger">{{error}}</div>
  <div *ngIf="successMessage" class="alert alert-success">{{successMessage}}</div>

  <div class="row justify-content-center" *ngIf="!loading">
    <div class="col-10">
      <form [formGroup]="form" (ngSubmit)="onSubmit()">
        <div class="row g-3">

          <!-- Id (Read-only, shown only in edit/view mode) -->
          <div class="col-12" *ngIf="isEditMode || isViewMode">
            <label class="form-label">Id</label>
            <input
              type="text"
              class="form-control"
              [value]="account?.id"
              readonly
              disabled>
          </div>

          <div class="col-md-4">
            <label class="form-label">Member # (COID) <span class="text-danger">*</span></label>
            <input class="form-control" formControlName="memberNumber" [class.is-invalid]="isFieldInvalid('memberNumber')" />
            <div class="invalid-feedback" *ngIf="isFieldInvalid('memberNumber')">Member # (COID) is required.</div>
          </div>
          <div class="col-md-4">
            <label class="form-label">Parent Member Account #</label>
            <input class="form-control" formControlName="parentMemberAccountNumber" />
          </div>
          <div class="col-md-4">
            <label class="form-label">Member Name <span class="text-danger">*</span></label>
            <input class="form-control" formControlName="facilityName" [class.is-invalid]="isFieldInvalid('facilityName')" />
            <div class="invalid-feedback" *ngIf="isFieldInvalid('facilityName')">Member Name is required.</div>
          </div>

          <div class="col-md-12">
            <label class="form-label">Address</label>
            <input class="form-control" formControlName="address" />
          </div>

          <div class="col-md-3">
            <label class="form-label">City</label>
            <input class="form-control" formControlName="city" />
          </div>
          <div class="col-md-3">
            <label class="form-label">State</label>
            <select class="form-select" formControlName="state">
              <option value="">Select state</option>
              <option *ngFor="let state of usStates" [value]="state">{{state}}</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Zip Code</label>
            <input class="form-control" formControlName="zipCode" />
          </div>
          <div class="col-md-3">
            <label class="form-label">Country</label>
            <input class="form-control" formControlName="country" />
          </div>

          <!-- Phone field hidden per user request -->
          <!-- <div class="col-md-6">
            <label class="form-label">Phone</label>
            <input class="form-control" formControlName="phoneNumber" />
          </div> -->


          <div class="col-md-4">
            <label class="form-label">Industry <span class="text-danger">*</span></label>
            <select class="form-select" formControlName="industryId" [class.is-invalid]="isFieldInvalid('industryId')">
              <option [ngValue]="null">Select an industry</option>
              <option *ngFor="let ind of industries" [ngValue]="ind.id">{{ind.name}}</option>
            </select>
            <div class="invalid-feedback" *ngIf="isFieldInvalid('industryId')">Industry is required.</div>
          </div>

          <div class="col-md-4">
            <label class="form-label">W9 Status</label>
            <select class="form-select" formControlName="w9">
              <option value=""></option>
              <option value="Submitted">Submitted</option>
              <option value="Not Submitted">Not Submitted</option>
            </select>
          </div>
          <!-- Tax ID field hidden per user request -->
          <!-- <div class="col-md-5">
            <label class="form-label">Tax ID</label>
            <input class="form-control" formControlName="taxId" />
          </div> -->
          <!-- Business Type field hidden per user request -->
          <!-- <div class="col-md-3">
            <label class="form-label">Business Type</label>
            <input class="form-control" formControlName="businessType" />
          </div> -->

          <div class="col-12 mt-3">
            <h5 class="fc-denim">Extended Fields</h5>
          </div>

          <div class="col-md-3">
            <label class="form-label">LOP Date</label>
            <input type="date" class="form-control" formControlName="lopDate" [class.has-value]="form.get('lopDate')?.value" />
          </div>

          <div class="col-md-9">
            <label class="form-label">Internal Notes</label>
            <textarea rows="2" class="form-control" formControlName="internalNotes"></textarea>
          </div>

          <div class="col-md-4">
            <label class="form-label">Salesforce Account Name <span class="text-danger">*</span></label>
            <input class="form-control" formControlName="salesforceAccountName" [class.is-invalid]="isFieldInvalid('salesforceAccountName')" (input)="onSalesforceManualEdit()" />
            <div class="invalid-feedback" *ngIf="isFieldInvalid('salesforceAccountName')">Salesforce Account Name is required.</div>
          </div>
          <div class="col-md-4">
            <label class="form-label">VM AP Number</label>
            <input class="form-control" formControlName="vmapNumber" />
          </div>
          <div class="col-md-4">
            <label class="form-label">Pay Type</label>
            <input class="form-control" formControlName="payType" />
          </div>

          <div class="col-md-6">
            <label class="form-label">VM Supplier Name</label>
            <input class="form-control" formControlName="vmSupplierName" />
          </div>
          <div class="col-md-6">
            <label class="form-label">VM Supplier Site</label>
            <input class="form-control" formControlName="vmSupplierSite" />
          </div>

          <div class="col-md-4">
            <label class="form-label">Entegra GPO #</label>
            <input class="form-control" formControlName="entegraGPONumber" />
          </div>
          <div class="col-md-4">
            <label class="form-label">Client Group #</label>
            <input class="form-control" formControlName="clientGroupNumber" />
          </div>

          <div class="col-md-4">
            <label class="form-label">Entegra ID #</label>
            <input class="form-control" formControlName="entegraIdNumber" />
          </div>
          <div class="col-md-4">
            <label class="form-label">Client Group Enrollment</label>
            <input type="text" class="form-control" formControlName="clientGroupEnrollment" [class.is-invalid]="isFieldInvalid('clientGroupEnrollment')" />
            <div class="invalid-feedback" *ngIf="isFieldInvalid('clientGroupEnrollment')">Please enter a valid number.</div>
          </div>
          <div class="col-md-4">
            <label class="form-label">Status</label>
            <select class="form-select" formControlName="status">
              <option value="Active">Active</option>
              <option value="Inactive">Inactive</option>
              <option value="Pending">Pending</option>
            </select>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="d-flex justify-content-end mt-4">
          <!-- View Mode Actions -->
          <div *ngIf="isViewMode" class="d-flex">
            <button type="button" class="btn btn-denim me-2" (click)="onCancel()">
              Back to List
            </button>
            <button type="button" class="btn btn-denim" (click)="toggleEditMode()">
              <i class="fa-solid fa-pen me-2"></i>Edit
            </button>
          </div>

          <!-- Edit/Create Mode Actions -->
          <div *ngIf="!isViewMode" class="d-flex">
            <button type="button" class="btn btn-denim me-2" (click)="onCancel()">
              Cancel
            </button>
            <button type="submit" class="btn btn-denim" [disabled]="form.invalid || submitting">
              <span *ngIf="submitting" class="spinner-border spinner-border-sm me-2"></span>
              {{isEditMode ? 'Update' : 'Create'}} Member Account
            </button>
          </div>
        </div>
      </form>

      <!-- Customer Accounts Section (edit/view mode only) -->
      <div *ngIf="(isEditMode || isViewMode) && account" class="mt-4">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Customer Accounts ({{ customerAccounts.length }})</h5>
          </div>
          <div class="card-body p-0">
            <div *ngIf="customerAccounts.length === 0" class="text-center py-3 text-muted">
              No customer accounts associated with this member account.
            </div>
            <div *ngIf="customerAccounts.length > 0" class="table-responsive">
              <table class="table table-sm table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th>ID</th>
                    <th>Account #</th>
                    <th>Name</th>
                    <th>Distributor</th>
                    <th>Status</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let ca of customerAccounts">
                    <td>{{ ca.id }}</td>
                    <td>{{ ca.customerAccountNumber || '-' }}</td>
                    <td>{{ ca.customerName || '-' }}</td>
                    <td>{{ ca.distributorName || '-' }}</td>
                    <td>
                      <span class="badge" [class.bg-success]="(ca.statusName || ca.status) === 'Active'" [class.bg-secondary]="(ca.statusName || ca.status) !== 'Active'">{{ ca.statusName || ca.status }}</span>
                    </td>
                    <td class="text-end">
                      <a class="btn btn-sm btn-outline-secondary" [routerLink]="['/admin/customer-accounts/view', ca.id]" title="View Customer Account">
                        <i class="fas fa-eye"></i>
                      </a>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

