<div class="container py-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="m-0">Clone Proposal</h2>
    <button type="button" class="btn btn-secondary" (click)="onCancel()">
      <i class="fas fa-arrow-left me-2"></i>Back to Proposal
    </button>
  </div>

  <div *ngIf="sourceProposal" class="alert alert-secondary mb-3">
    <i class="fas fa-info-circle me-2"></i>
    <strong>Cloning from:</strong> {{ getSourceProposalTitle() }}
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="text-center py-5">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2">Loading proposal data...</p>
  </div>

  <!-- Error Alert -->
  <div *ngIf="error" class="alert alert-danger" role="alert">
    <i class="fas fa-exclamation-triangle me-2"></i>{{ error }}
  </div>

  <!-- Form -->
  <div *ngIf="!loading && sourceProposal">
    <form [formGroup]="form" (ngSubmit)="onSubmit()">

      <!-- Basic Information -->
      <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0">Basic Information</h5>
            </div>
            <div class="card-body">
              <div class="row g-3">
                <!-- Row 1: Type and Title -->
                <div class="col-md-6">
                  <label class="form-label">Type <span class="text-danger">*</span></label>
                  <select
                    class="form-select"
                    formControlName="proposalTypeId"
                    [class.is-invalid]="isFieldInvalid('proposalTypeId')">
                    <option value="">Select Type</option>
                    <option *ngFor="let type of proposalTypes" [value]="type.id">{{ type.name }}</option>
                  </select>
                  <div class="invalid-feedback" *ngIf="isFieldInvalid('proposalTypeId')">
                    Type is required.
                  </div>
                </div>

                <div class="col-md-6">
                  <label class="form-label">Title <span class="text-danger">*</span></label>
                  <input
                    type="text"
                    class="form-control"
                    formControlName="title"
                    [class.is-invalid]="isFieldInvalid('title')"
                    maxlength="200">
                  <div class="invalid-feedback" *ngIf="isFieldInvalid('title')">
                    <div *ngIf="form.get('title')?.errors?.['required']">Title is required.</div>
                    <div *ngIf="form.get('title')?.errors?.['maxlength']">Title cannot exceed 200 characters.</div>
                  </div>
                </div>

                <!-- Status field hidden on clone -->
                <div class="col-md-3" style="display:none;">
                  <label class="form-label">Status <span class="text-danger">*</span></label>
                  <select
                    class="form-select"
                    formControlName="proposalStatusId"
                    [class.is-invalid]="isFieldInvalid('proposalStatusId')">
                    <option value="">Select Status</option>
                    <option *ngFor="let status of proposalStatuses" [value]="status.id">{{ status.name }}</option>
                  </select>
                </div>

                <!-- Row 2: Manufacturer, Start Date, End Date, Due Date -->
                <div class="col-md-3">
                  <label class="form-label">Manufacturer</label>
                  <select class="form-select" formControlName="manufacturerId">
                    <option value="">Select Manufacturer</option>
                    <option *ngFor="let manufacturer of manufacturers" [value]="manufacturer.id">{{ manufacturer.name }}</option>
                  </select>
                </div>

                <div class="col-md-3">
                  <label class="form-label">Start Date</label>
                  <input type="date" class="form-control" formControlName="startDate" [class.has-value]="form.get('startDate')?.value">
                </div>

                <div class="col-md-3">
                  <label class="form-label">End Date</label>
                  <input type="date" class="form-control" formControlName="endDate" [class.has-value]="form.get('endDate')?.value">
                </div>

                <div class="col-md-3">
                  <label class="form-label">Due Date</label>
                  <input type="date" class="form-control" formControlName="dueDate" [class.has-value]="form.get('dueDate')?.value">
                </div>

                <!-- Distributors multi-select with search -->
                <div class="col-12 col-md-4">
                  <label class="form-label">Distributors</label>
                  <div class="form-control p-2" (click)="togglePanel('distributorIds')" tabindex="0" style="cursor: pointer;">
                    <span class="badge text-bg-denim rounded-pill me-1 mb-1" *ngFor="let d of selectedDistributors">
                      {{d.name}}
                      <button type="button" class="btn-close btn-close-white btn-sm ms-1" (click)="removeFromMulti('distributorIds', d.id); $event.stopPropagation()" aria-label="Remove"></button>
                    </span>
                    <span class="text-muted" *ngIf="!selectedDistributors.length">Select distributors...</span>
                  </div>
                  <div class="position-relative">
                    <div class="dropdown-menu d-block w-100 p-2" *ngIf="showDistributorsPanel">
                      <input class="form-control mb-2" [value]="distributorFilter" (input)="applyDistributorFilter($any($event.target).value)">
                      <div style="max-height:240px; overflow:auto;">
                        <div class="form-check" *ngFor="let d of filteredDistributors">
                          <input class="form-check-input" type="checkbox" [checked]="isIdSelected('distributorIds', d.id)" (change)="toggleId('distributorIds', d.id)">
                          <label class="form-check-label">{{d.name}}</label>
                        </div>
                      </div>
                      <div class="mt-2 text-end">
                        <button type="button" class="btn btn-sm btn-secondary me-2" (click)="closePanel('distributorIds')">Close</button>
                        <button type="button" class="btn btn-sm btn-denim" (click)="applyPanel('distributorIds')">Apply</button>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Industries multi-select with search -->
                <div class="col-12 col-md-4">
                  <label class="form-label">Industries</label>
                  <div class="form-control p-2" (click)="togglePanel('industryIds')" tabindex="0" style="cursor: pointer;">
                    <span class="badge text-bg-denim rounded-pill me-1 mb-1" *ngFor="let i of selectedIndustries">
                      {{i.name}}
                      <button type="button" class="btn-close btn-close-white btn-sm ms-1" (click)="removeFromMulti('industryIds', i.id); $event.stopPropagation()" aria-label="Remove"></button>
                    </span>
                    <span class="text-muted" *ngIf="!selectedIndustries.length">Select industries...</span>
                  </div>
                  <div class="position-relative">
                    <div class="dropdown-menu d-block w-100 p-2" *ngIf="showIndustriesPanel">
                      <input class="form-control mb-2" [value]="industryFilter" (input)="applyIndustryFilter($any($event.target).value)">
                      <div style="max-height:240px; overflow:auto;">
                        <div class="form-check" *ngFor="let i of filteredIndustries">
                          <input class="form-check-input" type="checkbox" [checked]="isIdSelected('industryIds', i.id)" (change)="toggleId('industryIds', i.id)">
                          <label class="form-check-label">{{i.name}}</label>
                        </div>
                      </div>
                      <div class="mt-2 text-end">
                        <button type="button" class="btn btn-sm btn-secondary me-2" (click)="closePanel('industryIds')">Close</button>
                        <button type="button" class="btn btn-sm btn-denim" (click)="applyPanel('industryIds')">Apply</button>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- OpCos multi-select with search -->
                <div class="col-12 col-md-4">
                  <label class="form-label">OpCos</label>
                  <div class="form-control p-2" (click)="togglePanel('opcoIds')" tabindex="0" style="cursor: pointer;">
                    <span class="badge text-bg-denim rounded-pill me-1 mb-1" *ngFor="let o of selectedOpcos">
                      {{o.name}}
                      <button type="button" class="btn-close btn-close-white btn-sm ms-1" (click)="removeFromMulti('opcoIds', o.id); $event.stopPropagation()" aria-label="Remove"></button>
                    </span>
                    <span class="text-muted" *ngIf="!selectedOpcos.length">Select operating companies...</span>
                  </div>
                  <div class="position-relative">
                    <div class="dropdown-menu d-block w-100 p-2" *ngIf="showOpcoPanel">
                      <input class="form-control mb-2" [value]="opcoFilter" (input)="applyOpcoFilter($any($event.target).value)">
                      <div style="max-height:240px; overflow:auto;">
                        <div class="form-check" *ngFor="let o of filteredOpcos">
                          <input class="form-check-input" type="checkbox" [checked]="isIdSelected('opcoIds', o.id)" (change)="toggleId('opcoIds', o.id)">
                          <label class="form-check-label">{{o.name}}</label>
                        </div>
                      </div>
                      <div class="mt-2 text-end">
                        <button type="button" class="btn btn-sm btn-secondary me-2" (click)="closePanel('opcoIds')">Close</button>
                        <button type="button" class="btn btn-sm btn-denim" (click)="applyPanel('opcoIds')">Apply</button>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="col-12">
                  <label class="form-label">Internal Notes</label>
                  <textarea
                    class="form-control"
                    formControlName="internalNotes"
                    rows="3"
                    maxlength="1000"></textarea>
                  <div class="form-text">{{ form.get('internalNotes')?.value?.length || 0 }}/1000 characters</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Products -->
          <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Products</h5>
              <button
                type="button"
                class="btn btn-sm btn-primary"
                (click)="addProduct()">
                <i class="fas fa-plus me-1"></i>Add Product
              </button>
            </div>
            <div class="card-body">
              <!-- Search and Filter Controls -->
              <div class="row g-3 mb-3" *ngIf="productsArray.length > 0">
                <div class="col-md-4">
                  <input
                    type="text"
                    class="form-control"
                    placeholder="Search by product code, name, or notes..."
                    [(ngModel)]="productSearchTerm"
                    [ngModelOptions]="{standalone: true}"
                    (ngModelChange)="onProductSearch($event)">
                </div>
                <div class="col-md-3">
                  <select
                    class="form-select"
                    [(ngModel)]="productFilterPriceType"
                    [ngModelOptions]="{standalone: true}"
                    (ngModelChange)="onPriceTypeFilter($event)">
                    <option [ngValue]="null">All Price Types</option>
                    <option *ngFor="let pt of priceTypes" [ngValue]="pt.id">{{ pt.name }}</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <select
                    class="form-select"
                    [(ngModel)]="productFilterStatus"
                    [ngModelOptions]="{standalone: true}"
                    (ngModelChange)="onStatusFilter($event)">
                    <option [ngValue]="null">All Statuses</option>
                    <option *ngFor="let status of productProposalStatuses" [ngValue]="status.id">{{ status.name }}</option>
                  </select>
                </div>
                <div class="col-md-2">
                  <button type="button" class="btn btn-outline-secondary w-100" (click)="clearFilters()">
                    <i class="fas fa-times me-1"></i>Clear
                  </button>
                </div>
              </div>

              <div *ngIf="productsArray.length === 0" class="text-center py-4 text-muted">
                <i class="fas fa-box-open fa-2x mb-2"></i>
                <p>No products added yet. Click "Add Product" to get started.</p>
              </div>

              <div *ngIf="productsArray.length > 0 && totalProducts === 0" class="text-center py-4 text-muted">
                <i class="fas fa-search fa-2x mb-2"></i>
                <p>No products match your filters.</p>
              </div>

              <div *ngFor="let item of paginatedProducts; let i = index; trackBy: trackByIndex" class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-start">
                  <div class="flex-grow-1 me-3" style="min-width: 0;">
                    <ng-container *ngIf="item.control.get('productId')?.value as pid; else defaultTitle">
                      <ng-container *ngIf="getProductById(pid) as prod; else productNotFound">
                        <!-- Row 1: Product Code - Brand - Pack - Name -->
                        <div class="text-truncate" [title]="getProductHeaderTitle(pid)">
                          <strong>{{ prod.manufacturerProductCode || 'N/A' }}</strong>
                          <span *ngIf="prod.brand"> - {{ prod.brand }}</span>
                          <span *ngIf="prod.packSize"> - {{ prod.packSize }}</span>
                          <span *ngIf="prod.name || prod.description"> - {{ prod.name || prod.description }}</span>
                        </div>
                        <!-- Row 2: GTIN & Notes with Icons -->
                        <div class="text-muted small mt-1 text-truncate">
                          <span *ngIf="prod.gtin" class="me-3" [title]="'GTIN: ' + prod.gtin">
                            <i class="fas fa-barcode me-1"></i>{{ prod.gtin }}
                          </span>
                          <span *ngIf="prod.notes" [title]="'Notes: ' + prod.notes">
                            <i class="fas fa-sticky-note me-1"></i>{{ prod.notes }}
                          </span>
                        </div>
                      </ng-container>
                      <ng-template #productNotFound>
                        <div><strong>Product #{{ pid }}</strong></div>
                      </ng-template>
                    </ng-container>
                    <ng-template #defaultTitle>
                      <div><strong>Product {{ item.index + 1 }}</strong></div>
                    </ng-template>
                  </div>
                  <div class="d-flex align-items-center gap-2 flex-shrink-0">
                    <ng-container *ngIf="item.control.get('productId')?.value as pid">
                      <ng-container *ngIf="getProductById(pid) as prod">
                        <span class="badge" [ngClass]="getProductStatusBadgeClass(prod.status)" [title]="'Master Product Status: ' + prod.status">
                          {{ prod.status }}
                        </span>
                      </ng-container>
                    </ng-container>
                    <span class="badge" [ngClass]="statusBadgeClass(productStatusesView[item.index])" [title]="'Proposal Product Status'">
                      {{ getProductStatusLabel(productStatusesView[item.index]) }}
                    </span>
                    <button
                      type="button"
                      class="btn btn-sm btn-outline-danger"
                      (click)="openRemoveProductModal(item.index)"
                      title="Remove Product">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </div>
                <div class="card-body p-3">
                  <div [formGroup]="item.control">
                    <!-- Product Selection (only shown when no product selected) -->
                    <div class="row g-2 align-items-end mb-2" *ngIf="!item.control.get('productId')?.value">
                      <div class="col-12">
                        <label class="form-label">Product <span class="text-danger">*</span></label>
                        <select class="form-select" formControlName="productId" [class.is-invalid]="isProductFieldInvalid(item.index, 'productId')">
                          <option value="">Select Product</option>
                          <option *ngFor="let prod of products" [ngValue]="prod.id">
                            {{ (prod.manufacturerProductCode || prod.name) + (prod.description ? (' - ' + prod.description) : '') }}
                          </option>
                        </select>
                        <div class="invalid-feedback" *ngIf="isProductFieldInvalid(item.index, 'productId')">Product is required.</div>
                      </div>
                    </div>

                    <!-- Row 1: Price Type, UOM, Quantity, Billbacks -->
                    <div class="row g-2 align-items-end">
                      <div class="col-md-3">
                        <label class="form-label">Price Type</label>
                        <select class="form-select" formControlName="priceTypeId" (change)="onPriceTypeChange(item.control)">
                          <option [ngValue]="null">Select Type</option>
                          <option *ngFor="let priceType of priceTypes" [ngValue]="priceType.id">{{ priceType.name }}</option>
                        </select>
                      </div>

                      <div class="col-md-3">
                        <label class="form-label">UOM</label>
                        <select class="form-select" formControlName="uom">
                          <option value="">Select</option>
                          <option *ngFor="let u of uoms" [ngValue]="u">{{ u }}</option>
                        </select>
                      </div>

                      <div class="col-md-3">
                        <label class="form-label">Quantity</label>
                        <input type="number" class="form-control" formControlName="quantity" min="1">
                      </div>

                      <div class="col-md-3">
                        <label class="form-label">Billbacks</label>
                        <select class="form-select" formControlName="billbacksAllowed">
                          <option [ngValue]="false">No</option>
                          <option [ngValue]="true">Yes</option>
                        </select>
                      </div>
                    </div>

                    <!-- Info message for special price types -->
                    <div class="alert alert-info mt-2 mb-0" *ngIf="isPricingDisabledForProduct(item.control)">
                      <i class="fas fa-info-circle me-2"></i>
                      Pricing fields are disabled for this price type. Only internal notes can be added.
                    </div>

                    <!-- Row 2a: Allowance, Commercial DEL, Commercial FOB, PUA -->
                    <div class="row g-2 align-items-end mt-2">
                      <div class="col-md-3">
                        <label class="form-label">Allowance</label>
                        <div class="input-group">
                          <span class="input-group-text">$</span>
                          <input type="number" class="form-control" formControlName="allowance" step="0.0001" min="0">
                        </div>
                      </div>
                      <div class="col-md-3">
                        <label class="form-label">Commercial DEL</label>
                        <input type="number" class="form-control" formControlName="commercialDelPrice" step="0.01" min="0">
                      </div>
                      <div class="col-md-3">
                        <label class="form-label">Commercial FOB</label>
                        <input type="number" class="form-control" formControlName="commercialFobPrice" step="0.01" min="0">
                      </div>
                      <div class="col-md-3">
                        <label class="form-label">Pickup Allowance (PUA)</label>
                        <input type="number" class="form-control" formControlName="pua" step="0.01" min="0">
                      </div>
                    </div>

                    <!-- Row 2b: Fee for Service, NOI (Y/N) -->
                    <div class="row g-2 align-items-end mt-2">
                      <div class="col">
                        <label class="form-label">Fee for Service</label>
                        <input type="number" class="form-control" formControlName="ffsPrice" step="0.01" min="0">
                      </div>
                      <div class="col">
                        <label class="form-label">NOI</label>
                        <select class="form-select" formControlName="noiPrice">
                          <option [ngValue]="null">Select</option>
                          <option [ngValue]="true">Y</option>
                          <option [ngValue]="false">N</option>
                        </select>
                      </div>
                    </div>

                    <!-- Notes -->
                    <div class="row g-2 mt-3">
                      <div class="col-12 col-lg-6">
                        <label class="form-label">Manufacturer Notes</label>
                        <input type="text" class="form-control" formControlName="manufacturerNotes" maxlength="1000">
                      </div>
                      <div class="col-12 col-lg-6">
                        <label class="form-label">Internal Notes</label>
                        <input type="text" class="form-control" formControlName="internalNotes" maxlength="1000">
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Pagination Controls -->
              <div class="d-flex flex-row-reverse mt-3" *ngIf="productsArray.length > 0 && totalProducts > 0">
                <ul class="pagination pagination-sm mb-0">
                  <li class="page-item" [class.disabled]="currentPage === 1">
                    <a href="#" class="page-link" (click)="onPageChange(1); $event.preventDefault()">&lt;&lt;</a>
                  </li>
                  <li class="page-item" [class.disabled]="currentPage === 1">
                    <a href="#" class="page-link" (click)="onPageChange(currentPage - 1); $event.preventDefault()">&lt;</a>
                  </li>
                  <li
                    *ngFor="let page of getPageNumbers()"
                    class="page-item"
                    [class.active]="page === currentPage"
                    [class.disabled]="page === -1">
                    <a
                      href="#"
                      class="page-link"
                      (click)="page !== -1 ? onPageChange(page) : null; $event.preventDefault()">
                      {{page === -1 ? '...' : page}}
                    </a>
                  </li>
                  <li class="page-item" [class.disabled]="currentPage === totalPages">
                    <a href="#" class="page-link" (click)="onPageChange(currentPage + 1); $event.preventDefault()">&gt;</a>
                  </li>
                  <li class="page-item" [class.disabled]="currentPage === totalPages">
                    <a href="#" class="page-link" (click)="onPageChange(totalPages); $event.preventDefault()">&gt;&gt;</a>
                  </li>
                </ul>

                <div class="me-5 align-self-center">
                  <span>{{ ((currentPage - 1) * pageSize) + 1 }} to {{ Math.min(currentPage * pageSize, totalProducts) }} of {{ totalProducts }}</span>
                </div>

                <div class="me-5 align-self-center">
                  <label class="form-label m-0" for="pageSize">Rows per page:</label>
                  <select
                    class="m-0 p-0 border-top-0 border-start-0 border-end-0 border-bottom-1"
                    [(ngModel)]="pageSize"
                    [ngModelOptions]="{standalone: true}"
                    (ngModelChange)="onPageSizeChange($event)"
                    name="pageSize">
                    <option [ngValue]="1">1</option>
                    <option [ngValue]="5">5</option>
                    <option [ngValue]="10">10</option>
                    <option [ngValue]="25">25</option>
                    <option [ngValue]="50">50</option>
                  </select>
                </div>
              </div>
            </div>
          </div>

      <!-- Bottom actions -->
      <div class="d-flex justify-content-end mt-3">
        <button type="button" class="btn btn-secondary me-2" (click)="onCancel()" [disabled]="submitting">Cancel</button>
        <button
          type="submit"
          class="btn btn-primary"
          [disabled]="submitting || form.invalid">
          <span *ngIf="submitting" class="spinner-border spinner-border-sm me-2"></span>
          <i *ngIf="!submitting" class="fas fa-copy me-2"></i>
          {{ submitting ? 'Cloning...' : 'Create Clone' }}
        </button>
      </div>
    </form>
  </div>
</div>


<!-- Remove Product Confirmation Modal -->
<div *ngIf="showRemoveProductModal" class="modal fade show d-block" tabindex="-1" role="dialog" aria-modal="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Remove Product</h5>
        <button type="button" class="btn-close" aria-label="Close" (click)="closeRemoveProductModal()"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to remove this product from the proposal?</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-denim" (click)="closeRemoveProductModal()">Cancel</button>
        <button type="button" class="btn btn-denim" (click)="confirmRemoveProduct()">Remove</button>
      </div>
    </div>
  </div>
</div>
<!-- Backdrop -->
<div *ngIf="showRemoveProductModal" class="modal-backdrop fade show"></div>
