<main class="container">
  <!-- Breadcrumb -->
  <nav aria-label="breadcrumb" id="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a routerLink="/admin/proposals">Proposals</a></li>
      <li class="breadcrumb-item active">Create Proposal</li>
    </ol>
  </nav>

  <!-- Header -->
  <h3>Create Proposal</h3>

  <!-- Loading State -->
  <div *ngIf="loading" class="text-center py-5">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2">Loading form data...</p>
  </div>

  <!-- Error Alert -->
  <div *ngIf="error" class="alert alert-danger" role="alert">
    <i class="fas fa-exclamation-triangle me-2"></i>{{ error }}
  </div>

  <!-- Hidden file input for Excel upload -->
  <input type="file" #excelFileInput accept=".xlsx,.xls" style="display: none" (change)="onExcelFileSelected($event)" />

  <!-- Form -->
  <div *ngIf="!loading">
    <form [formGroup]="form" (ngSubmit)="onSubmit()">
      <div class="row">
        <div class="col-12">
          <!-- Basic Information -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="mb-0">Basic Information</h5>
            </div>
            <div class="card-body">
              <div class="row g-3">
                <!-- Row 1: Type and Title -->
                <div class="col-md-6">
                  <label class="form-label">Type <span class="text-danger">*</span></label>
                  <select
                    class="form-select"
                    formControlName="proposalTypeId"
                    [class.is-invalid]="isFieldInvalid('proposalTypeId')">
                    <option [ngValue]="null">Select Type</option>
                    <option *ngFor="let type of proposalTypes" [ngValue]="type.id">{{ type.name }}</option>
                  </select>
                  <div class="invalid-feedback" *ngIf="isFieldInvalid('proposalTypeId')">
                    Type is required.
                  </div>
                </div>

                <div class="col-md-6">
                  <label class="form-label">Title <span class="text-danger">*</span></label>
                  <input
                    type="text"
                    class="form-control"
                    formControlName="title"
                    [class.is-invalid]="isFieldInvalid('title')"
                    maxlength="200">
                  <div class="invalid-feedback" *ngIf="isFieldInvalid('title')">
                    <div *ngIf="form.get('title')?.errors?.['required']">Title is required.</div>
                    <div *ngIf="form.get('title')?.errors?.['maxlength']">Title cannot exceed 200 characters.</div>
                  </div>
                </div>

                <!-- Row 2: Manufacturer, Start Date, End Date -->
                <!-- Manufacturer: Admin/NPP can select; Manufacturer users see read-only name -->
                <div class="col-md-4" *ngIf="isAdminOrNpp(); else manufacturerReadonly">
                  <label class="form-label">Manufacturer</label>
                  <div class="form-select" (click)="toggleManufacturerPanel()" tabindex="0" style="cursor: pointer;">
                    <span *ngIf="form.get('manufacturerId')?.value; else mfrPlaceholder">
                      {{ getManufacturerName(form.get('manufacturerId')?.value) }}
                    </span>
                    <ng-template #mfrPlaceholder>
                      <span class="text-muted">Select manufacturer...</span>
                    </ng-template>
                  </div>
                  <div class="position-relative">
                    <div class="dropdown-menu d-block w-100 p-2" *ngIf="showManufacturerPanel">
                      <input class="form-control mb-2" [value]="manufacturerFilter" (input)="applyManufacturerFilter($any($event.target).value)">
                      <div style="max-height:240px; overflow:auto;">
                        <div class="form-check" *ngFor="let m of filteredManufacturers">
                          <input class="form-check-input" type="radio" name="manufacturerOptions" [checked]="form.get('manufacturerId')?.value === m.id" (change)="selectManufacturer(m.id)">
                          <label class="form-check-label">{{ m.name }}</label>
                        </div>
                      </div>
                      <div class="mt-2 text-end">
                        <button type="button" class="btn btn-sm btn-secondary" (click)="closeManufacturerPanel()">Close</button>
                      </div>
                    </div>
                  </div>
                </div>
                <ng-template #manufacturerReadonly>
                  <div class="col-md-4" *ngIf="isManufacturerUser()">
                    <label class="form-label">Manufacturer</label>
                    <input type="text" class="form-control" [value]="manufacturerNameLabel || 'Manufacturer'" readonly>
                  </div>
                </ng-template>

                <div class="col-md-3">
                  <label class="form-label">Start Date</label>
                  <input type="date" class="form-control" formControlName="startDate" [class.has-value]="form.get('startDate')?.value">
                </div>

                <div class="col-md-3">
                  <label class="form-label">End Date</label>
                  <input type="date" class="form-control" formControlName="endDate" [class.has-value]="form.get('endDate')?.value">
                </div>

                <div class="col-md-2">
                  <label class="form-label">Due Date</label>
                  <input type="date" class="form-control" formControlName="dueDate" [class.has-value]="form.get('dueDate')?.value">
                </div>

                <!-- Row 3: Distributors, Industries, OpCos (only shown for non-Amendment proposals) -->
                <ng-container *ngIf="!isAmendment()">
                  <!-- Distributors multi-select with search -->
                  <div class="col-12 col-md-4">
                    <label class="form-label">Distributors</label>
                    <div class="form-control p-2" (click)="togglePanel('distributorIds')" tabindex="0" style="cursor: pointer;">
                      <span class="badge text-bg-denim rounded-pill me-1 mb-1" *ngFor="let d of selectedDistributors">
                        {{d.name}}
                        <button type="button" class="btn-close btn-close-white btn-sm ms-1" (click)="removeFromMulti('distributorIds', d.id); $event.stopPropagation()" aria-label="Remove"></button>
                      </span>
                      <span class="text-muted" *ngIf="!selectedDistributors.length">Select distributors...</span>
                    </div>
                    <div class="position-relative">
                      <div class="dropdown-menu d-block w-100 p-2" *ngIf="showDistributorsPanel">
                        <input class="form-control mb-2" [value]="distributorFilter" (input)="applyDistributorFilter($any($event.target).value)">
                        <div style="max-height:240px; overflow:auto;">
                          <div class="form-check" *ngFor="let d of filteredDistributors">
                            <input class="form-check-input" type="checkbox" [checked]="isIdSelected('distributorIds', d.id)" (change)="toggleId('distributorIds', d.id)">
                            <label class="form-check-label">{{d.name}}</label>
                          </div>
                        </div>
                        <div class="mt-2 text-end">
                          <button type="button" class="btn btn-sm btn-secondary me-2" (click)="closePanel('distributorIds')">Close</button>
                          <button type="button" class="btn btn-sm btn-denim" (click)="applyPanel('distributorIds')">Apply</button>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Industries multi-select with search -->
                  <div class="col-12 col-md-4">
                    <label class="form-label">Industries</label>
                    <div class="form-control p-2" (click)="togglePanel('industryIds')" tabindex="0" style="cursor: pointer;">
                      <span class="badge text-bg-denim rounded-pill me-1 mb-1" *ngFor="let i of selectedIndustries">
                        {{i.name}}
                        <button type="button" class="btn-close btn-close-white btn-sm ms-1" (click)="removeFromMulti('industryIds', i.id); $event.stopPropagation()" aria-label="Remove"></button>
                      </span>
                      <span class="text-muted" *ngIf="!selectedIndustries.length">Select industries...</span>
                    </div>
                    <div class="position-relative">
                      <div class="dropdown-menu d-block w-100 p-2" *ngIf="showIndustriesPanel">
                        <input class="form-control mb-2" [value]="industryFilter" (input)="applyIndustryFilter($any($event.target).value)">
                        <div style="max-height:240px; overflow:auto;">
                          <div class="form-check" *ngFor="let i of filteredIndustries">
                            <input class="form-check-input" type="checkbox" [checked]="isIdSelected('industryIds', i.id)" (change)="toggleId('industryIds', i.id)">
                            <label class="form-check-label">{{i.name}}</label>
                          </div>
                        </div>
                        <div class="mt-2 text-end">
                          <button type="button" class="btn btn-sm btn-secondary me-2" (click)="closePanel('industryIds')">Close</button>
                          <button type="button" class="btn btn-sm btn-denim" (click)="applyPanel('industryIds')">Apply</button>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- OpCos multi-select with search -->
                  <div class="col-12 col-md-4">
                    <label class="form-label">OpCos</label>
                    <div class="form-control p-2" (click)="togglePanel('opcoIds')" tabindex="0" style="cursor: pointer;">
                      <span class="badge text-bg-denim rounded-pill me-1 mb-1" *ngFor="let o of selectedOpcos">
                        {{o.name}}
                        <button type="button" class="btn-close btn-close-white btn-sm ms-1" (click)="removeFromMulti('opcoIds', o.id); $event.stopPropagation()" aria-label="Remove"></button>
                      </span>
                      <span class="text-muted" *ngIf="!selectedOpcos.length">Select operating companies...</span>
                    </div>
                    <div class="position-relative">
                      <div class="dropdown-menu d-block w-100 p-2" *ngIf="showOpcoPanel">
                        <input class="form-control mb-2" [value]="opcoFilter" (input)="applyOpcoFilter($any($event.target).value)">
                        <div style="max-height:240px; overflow:auto;">
                          <div class="form-check" *ngFor="let o of filteredOpcos">
                            <input class="form-check-input" type="checkbox" [checked]="isIdSelected('opcoIds', o.id)" (change)="toggleId('opcoIds', o.id)">
                            <label class="form-check-label">{{o.name}}</label>
                          </div>
                        </div>
                        <div class="mt-2 text-end">
                          <button type="button" class="btn btn-sm btn-secondary me-2" (click)="closePanel('opcoIds')">Close</button>
                          <button type="button" class="btn btn-sm btn-denim" (click)="applyPanel('opcoIds')">Apply</button>
                        </div>
                      </div>
                    </div>
                  </div>
                </ng-container>

                <!-- Internal Notes -->
                <div class="col-12">
                  <label class="form-label">Internal Notes</label>
                  <textarea
                    class="form-control"
                    formControlName="internalNotes"
                    rows="3"
                    maxlength="1000"></textarea>
                  <div class="form-text">{{ form.get('internalNotes')?.value?.length || 0 }}/1000 characters</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Amendment Details (visible when a contract is selected for Amendment) -->
          <div class="card mb-4" *ngIf="form.get('amendedContractId')?.value">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Amendment Details</h5>
              <span class="badge bg-secondary">Contract #{{ form.get('amendedContractId')?.value }}</span>
            </div>
            <div class="card-body">

              <div class="mb-3">
                <label class="form-label">Distributors from Contract</label>
                <div class="border rounded p-2 bg-light">
                  <span class="badge text-bg-secondary me-1 mb-1" *ngFor="let d of amendmentDistributors">{{d.name}}</span>
                  <span class="text-muted" *ngIf="!amendmentDistributors.length">None</span>
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label">Industries from Contract</label>
                <div class="border rounded p-2 bg-light">
                  <span class="badge text-bg-secondary me-1 mb-1" *ngFor="let i of amendmentIndustries">{{i.name}}</span>
                  <span class="text-muted" *ngIf="!amendmentIndustries.length">None</span>
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label">OpCos from Contract</label>
                <div class="border rounded p-2 bg-light">
                  <span class="badge text-bg-secondary me-1 mb-1" *ngFor="let o of amendmentOpcos">{{o.name}}</span>
                  <span class="text-muted" *ngIf="!amendmentOpcos.length">None</span>
                </div>
              </div>

            </div>
          </div>

          <!-- Products -->
          <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Products</h5>
              <div class="btn-group">
                <button type="button" class="btn btn-sm btn-outline-secondary" (click)="downloadExcelTemplate()" [disabled]="!form.get('manufacturerId')?.value" title="Download Excel template with all manufacturer products">
                  <i class="fas fa-file-download me-1"></i>Template
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary" (click)="exportProducts()" [disabled]="productsArray.length === 0" title="Export products to Excel">
                  <i class="fas fa-download me-1"></i>Export
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary" (click)="uploadExcelFile()" [disabled]="!form.get('manufacturerId')?.value || uploadingExcel" title="Upload Excel file with product pricing">
                  <i class="fas fa-upload me-1"></i>{{ uploadingExcel ? 'Uploading...' : 'Import' }}
                </button>
                <button type="button" class="btn btn-sm btn-denim" (click)="openAddProductModal()" [disabled]="!form.get('manufacturerId')?.value">
                  <i class="fas fa-plus me-1"></i>Add Product
                </button>
                <button type="button" class="btn btn-sm btn-outline-primary" (click)="onAddProductClick()" [disabled]="!form.get('manufacturerId')?.value">
                  <i class="fas fa-list me-1"></i>Select Multiple
                </button>
              </div>
            </div>
            @if (excelFeedback) {
              <div class="alert alert-{{excelFeedback.type}} alert-dismissible fade show m-3 mb-0" role="alert">
                @if (excelFeedback.type === 'success') {
                  <i class="fas fa-check-circle me-2"></i>
                } @else if (excelFeedback.type === 'warning') {
                  <i class="fas fa-exclamation-triangle me-2"></i>
                } @else {
                  <i class="fas fa-times-circle me-2"></i>
                }
                {{ excelFeedback.message }}
                <button type="button" class="btn-close" (click)="excelFeedback = null"></button>
              </div>
            }
            <div class="card-body">
              <!-- Product Selection Modal (tabular layout) -->
              <div class="modal fade show" tabindex="-1" *ngIf="showProductModal" style="display:block; background: rgba(0,0,0,0.5);">
                <div class="modal-dialog modal-xl">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title">Select Products</h5>
                      <button type="button" class="btn-close" aria-label="Close" (click)="closeProductModal()"></button>
                    </div>
                    <div class="modal-body">
                      <div class="mb-3">
                        <input class="form-control" [(ngModel)]="productSearch" [ngModelOptions]="{standalone: true}" placeholder="Search by product code, name, or pack size...">
                      </div>
                      <div style="max-height:450px; overflow:auto;">
                        <table class="table table-sm table-hover">
                          <thead class="table-light sticky-top">
                            <tr>
                              <th style="width: 50px;">
                                <input class="form-check-input" type="checkbox" [(ngModel)]="selectAllProducts" [ngModelOptions]="{standalone: true}" (change)="toggleSelectAllProducts()" id="chkSelectAllProducts" title="Select All">
                              </th>
                              <th>Product Code</th>
                              <th>Name</th>
                              <th>Pack Size</th>
                            </tr>
                          </thead>
                          <tbody>
                            <tr *ngFor="let prod of filteredModalProducts()" [class.table-active]="selectedProductIds.has(prod.id)">
                              <td>
                                <input class="form-check-input" type="checkbox" [checked]="selectedProductIds.has(prod.id)" (change)="toggleProductSelection(prod.id, $any($event.target).checked)" [id]="'p_'+prod.id">
                              </td>
                              <td>{{ prod.manufacturerProductCode || '-' }}</td>
                              <td>{{ prod.name }}</td>
                              <td>{{ prod.packSize || '-' }}</td>
                            </tr>
                            <tr *ngIf="filteredModalProducts().length === 0">
                              <td colspan="4" class="text-center text-muted py-3">No products found</td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" (click)="closeProductModal()">Cancel</button>
                      <button type="button" class="btn btn-denim" (click)="addSelectedProducts()">Add Selected Products ({{ selectedProductIds.size }})</button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Contract Selection Modal for Amendment -->
              <div class="modal fade show" tabindex="-1" *ngIf="showContractModal" style="display:block; background: rgba(0,0,0,0.5);">
                <div class="modal-dialog modal-lg">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title">Select Contract for Amendment</h5>
                      <button type="button" class="btn-close" aria-label="Close" (click)="closeContractModal()"></button>
                    </div>
                    <div class="modal-body">
                      <div class="mb-2">
                        <input class="form-control" [(ngModel)]="contractSearch" [ngModelOptions]="{standalone: true}" (input)="onContractSearchChange($any($event.target).value)" placeholder="Search by name, manufacturer, or number...">
                      </div>
                      <div *ngIf="contractsLoading" class="text-center py-3">
                        <div class="spinner-border" role="status"></div>
                      </div>
                      <div *ngIf="!contractsLoading" style="max-height:380px; overflow:auto;">
                        <div class="list-group">
                          <button type="button" class="list-group-item list-group-item-action" *ngFor="let c of contracts" [class.active]="selectedContract?.id === c.id" (click)="selectContract(c)">
                            <div class="d-flex w-100 justify-content-between">
                              <h6 class="mb-1">{{ c.name || c.title }}</h6>
                              <small>#{{ c.id }}</small>
                            </div>
                            <p class="mb-1" *ngIf="c.manufacturerName">Manufacturer: {{ c.manufacturerName }}</p>
                            <small>{{ c.startDate | date }} - {{ c.endDate | date }}</small>
                          </button>
                        </div>
                        <div *ngIf="contracts.length === 0" class="text-center text-muted py-3">No contracts found</div>
                      </div>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary" (click)="closeContractModal()">Cancel</button>
                      <button type="button" class="btn btn-denim" [disabled]="!selectedContract" (click)="confirmContractSelection()">Select Contract</button>
                    </div>
                  </div>
                </div>
              </div>


              <div *ngIf="productsArray.length === 0" class="text-center py-4 text-muted">
                <i class="fas fa-box-open fa-2x mb-2"></i>
                <p>No products added yet. Click "Add Products" to get started.</p>
              </div>

              <div *ngFor="let product of productsArray.controls; let i = index; trackBy: trackByIndex" class="card mb-3">
                <div class="card-header">
                  <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1 me-3" style="min-width: 0;">
                      <ng-container *ngIf="$any(product).get('productId')?.value as pid; else defaultTitle">
                        <ng-container *ngIf="getProductById(pid) as prod; else productNotFound">
                          <!-- Row 1: Product Code - Brand - Pack - Name -->
                          <div class="text-truncate" [title]="getProductHeaderTitle(pid)">
                            <strong>{{ prod.manufacturerProductCode || 'N/A' }}</strong>
                            <span *ngIf="prod.brand"> - {{ prod.brand }}</span>
                            <span *ngIf="prod.packSize"> - {{ prod.packSize }}</span>
                            <span *ngIf="prod.name || prod.description"> - {{ prod.name || prod.description }}</span>
                          </div>
                          <!-- Row 2: GTIN & Notes with Icons -->
                          <div class="text-muted small mt-1">
                            <span *ngIf="prod.gtin" class="me-3" [title]="'GTIN: ' + prod.gtin">
                              <i class="fas fa-barcode me-1"></i>{{ prod.gtin }}
                            </span>
                            <span *ngIf="prod.notes" [title]="'Notes: ' + prod.notes">
                              <i class="fas fa-sticky-note me-1"></i>{{ prod.notes.length > 30 ? (prod.notes.substring(0, 30) + '...') : prod.notes }}
                            </span>
                          </div>
                        </ng-container>
                        <ng-template #productNotFound>
                          <div><strong>Product #{{ pid }}</strong></div>
                        </ng-template>
                      </ng-container>
                      <ng-template #defaultTitle>
                        <div><strong>Product {{ i + 1 }}</strong></div>
                      </ng-template>
                    </div>
                    <div class="d-flex align-items-center gap-2 flex-shrink-0">
                      <ng-container *ngIf="$any(product).get('productId')?.value as pid">
                        <ng-container *ngIf="getProductById(pid) as prod">
                          <span class="badge" [ngClass]="getProductStatusBadgeClass(prod.status)" [title]="'Master Product Status: ' + prod.status">
                            {{ prod.status }}
                          </span>
                        </ng-container>
                      </ng-container>
                      <span class="badge" [ngClass]="statusBadgeClass($any(product).get('productProposalStatusId')?.value)" [title]="'Proposal Product Status'">
                        {{ getProductStatusLabel($any(product).get('productProposalStatusId')?.value) }}
                      </span>
                      <button type="button" class="btn btn-sm btn-outline-danger" (click)="removeProduct(i)" title="Remove Product">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </div>
                </div>
                <div class="card-body p-3">
                  <div [formGroup]="$any(product)">
                    <!-- Product Selection (only shown when no product selected) -->
                    <div class="row g-2 align-items-end mb-2" *ngIf="!$any(product).get('productId')?.value">
                      <div class="col-12">
                        <label class="form-label">Product <span class="text-danger">*</span></label>
                        <select class="form-select" formControlName="productId" [class.is-invalid]="isProductFieldInvalid(i, 'productId')">
                          <option value="">Select Product</option>
                          <option *ngFor="let prod of products" [ngValue]="prod.id">{{ prod.name }}</option>
                        </select>
                        <div class="invalid-feedback" *ngIf="isProductFieldInvalid(i, 'productId')">Product is required.</div>
                      </div>
                    </div>

                    <!-- Row 1: Price Type, UOM, Quantity, Billbacks -->
                    <div class="row g-2 align-items-end">
                      <div class="col-md-3">
                        <label class="form-label">Price Type</label>
                        <select class="form-select" formControlName="priceTypeId" (change)="onPriceTypeChange($any(product))">
                          <option [ngValue]="null">Select Type</option>
                          <option *ngFor="let priceType of priceTypes" [ngValue]="priceType.id">{{ priceType.name }}</option>
                        </select>
                      </div>

                      <div class="col-md-3">
                        <label class="form-label">UOM</label>
                        <select class="form-select" formControlName="uom">
                          <option value="">Select</option>
                          <option *ngFor="let u of uoms" [ngValue]="u">{{ u }}</option>
                        </select>
                      </div>

                      <div class="col-md-3">
                        <label class="form-label">Quantity</label>
                        <input type="number" class="form-control" formControlName="quantity" min="1">
                      </div>

                      <div class="col-md-3">
                        <label class="form-label">Billbacks</label>
                        <select class="form-select" formControlName="billbacksAllowed">
                          <option [ngValue]="false">No</option>
                          <option [ngValue]="true">Yes</option>
                        </select>
                      </div>
                    </div>

                    <!-- Info message for special price types -->
                    <div class="alert alert-info mt-2 mb-0" *ngIf="isPricingDisabledForProduct($any(product))">
                      <i class="fas fa-info-circle me-2"></i>
                      Pricing fields are disabled for this price type. Only internal notes can be added.
                    </div>

                    <!-- Amendment info (if applicable) -->
                    <div class="row g-2 mt-1" *ngIf="isAmendment() && form.get('amendedContractId')?.value">
                      <div class="col-12">
                        <div class="small text-muted" *ngIf="getAmendmentPriceForProduct($any(product).get('productId')?.value) as cp">
                          Contract: {{ cp?.priceType || '-' }} | Price: {{ (cp?.price ?? cp?.commercialDelPrice ?? cp?.commercialFobPrice ?? cp?.ffsPrice ?? cp?.noiPrice) ?? '-' }} | Allowance: {{ cp?.allowance ?? '-' }} | UOM: {{ cp?.uom || '-' }} | Tier: {{ cp?.tier || '-' }}
                        </div>
                      </div>
                      <div class="col-md-3">
                        <label class="form-label">Amendment Action</label>
                        <select class="form-select" formControlName="amendmentActionId" [disabled]="true">
                          <option *ngFor="let a of amendmentActions" [ngValue]="a.id">{{ a.name }}</option>
                        </select>
                      </div>
                    </div>

                    <!-- Row 2a: Allowance, Commercial DEL, Commercial FOB, PUA -->
                    <div class="row g-2 align-items-end mt-2">
                      <div class="col-md-3">
                        <label class="form-label">Allowance</label>
                        <div class="input-group">
                          <span class="input-group-text">$</span>
                          <input type="number" class="form-control" formControlName="allowance" step="0.0001" min="0">
                        </div>
                      </div>
                      <div class="col-md-3">
                        <label class="form-label">Commercial DEL</label>
                        <input type="number" class="form-control" formControlName="commercialDelPrice" step="0.01" min="0">
                      </div>
                      <div class="col-md-3">
                        <label class="form-label">Commercial FOB</label>
                        <input type="number" class="form-control" formControlName="commercialFobPrice" step="0.01" min="0">
                      </div>
                      <div class="col-md-3">
                        <label class="form-label">Pickup Allowance (PUA)</label>
                        <input type="number" class="form-control" formControlName="pua" step="0.01" min="0">
                      </div>
                    </div>

                    <!-- Row 2b: Fee for Service, NOI (Y/N) -->
                    <div class="row g-2 align-items-end mt-2">
                      <div class="col">
                        <label class="form-label">Fee for Service</label>
                        <input type="number" class="form-control" formControlName="ffsPrice" step="0.01" min="0">
                      </div>
                      <div class="col">
                        <label class="form-label">NOI</label>
                        <select class="form-select" formControlName="noiPrice">
                          <option [ngValue]="null">Select</option>
                          <option [ngValue]="true">Y</option>
                          <option [ngValue]="false">N</option>
                        </select>
                      </div>
                    </div>

                    <!-- Row 3: Notes -->
                    <div class="row g-2 mt-2">
                      <div [ngClass]="isManufacturerUser() ? 'col-12' : 'col-12 col-lg-6'">
                        <label class="form-label">{{ isManufacturerUser() ? 'Notes' : 'Manufacturer Notes' }}</label>
                        <input type="text" class="form-control" formControlName="manufacturerNotes" maxlength="1000">
                      </div>
                      <div class="col-12 col-lg-6" *ngIf="!isManufacturerUser()">
                        <label class="form-label">Internal Notes</label>
                        <input type="text" class="form-control" formControlName="internalNotes" maxlength="1000">
                      </div>
                    </div>

                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>


      </div>
      <!-- Form actions: consistent with other admin forms -->
      <div class="d-flex justify-content-end mt-3">
        <button type="button" class="btn btn-secondary me-2" (click)="onCancel()" [disabled]="submitting">Cancel</button>
        <button type="submit" class="btn btn-denim" [disabled]="submitting || form.invalid">
          <span *ngIf="submitting" class="spinner-border spinner-border-sm me-2"></span>
          {{ submitting ? 'Creating...' : 'Create Proposal' }}
        </button>
      </div>
    </form>
  </div>
</main>

<!-- Add Product Modal -->
<div *ngIf="showAddProductModal" class="modal fade show d-block" tabindex="-1" role="dialog" aria-modal="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add Product</h5>
        <button type="button" class="btn-close" aria-label="Close" (click)="cancelAddProductModal()"></button>
      </div>
      <div class="modal-body" *ngIf="addProductForm">
        <div [formGroup]="addProductForm">
          <!-- Error Alert -->
          <div *ngIf="addProductError" class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>{{ addProductError }}
          </div>

          <!-- Product Selection via Search Modal -->
          <div class="mb-3">
            <div class="d-flex align-items-center mb-2">
              <label class="form-label mb-0 me-3">Product <span class="text-danger">*</span></label>
              <button type="button" class="btn btn-sm btn-denim me-2" (click)="openProductSearchForAdd()">
                <i class="fa-solid fa-search me-1"></i>{{ selectedAddProduct ? 'Change' : 'Search' }}
              </button>
              <button *ngIf="selectedAddProduct" type="button" class="btn btn-sm btn-outline-secondary" (click)="clearAddProduct()">
                <i class="fa-solid fa-times me-1"></i>Clear
              </button>
            </div>
            @if (selectedAddProduct) {
              <div class="table-responsive">
                <table class="table table-bordered table-sm mb-0">
                  <thead class="table-light">
                    <tr>
                      <th>ID</th>
                      <th>MFR Code</th>
                      <th>Brand</th>
                      <th>Name</th>
                      <th>Pack Size</th>
                      <th>Manufacturer</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>{{ selectedAddProduct.id }}</td>
                      <td>{{ selectedAddProduct.manufacturerProductCode || '-' }}</td>
                      <td>{{ selectedAddProduct.brand || '-' }}</td>
                      <td>{{ selectedAddProduct.name || selectedAddProduct.description || '-' }}</td>
                      <td>{{ selectedAddProduct.packSize || '-' }}</td>
                      <td>{{ selectedAddProduct.manufacturerName || '-' }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            } @else {
              <div class="text-muted small">Click Search to find and select a product.</div>
            }
            <div class="invalid-feedback d-block" *ngIf="isAddProductFieldInvalid('productId')">Product is required.</div>
          </div>

          <!-- Row 1: Price Type, UOM, Quantity, Billbacks -->
          <div class="row g-2 align-items-end">
            <div class="col-md-3">
              <label class="form-label">Price Type</label>
              <select class="form-select" formControlName="priceTypeId">
                <option [ngValue]="null">Select Type</option>
                <option *ngFor="let priceType of priceTypes" [ngValue]="priceType.id">{{ priceType.name }}</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">UOM</label>
              <select class="form-select" formControlName="uom">
                <option value="">Select</option>
                <option *ngFor="let u of uoms" [ngValue]="u">{{ u }}</option>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Quantity</label>
              <input type="number" class="form-control" formControlName="quantity" min="1">
            </div>
            <div class="col-md-3">
              <label class="form-label">Billbacks</label>
              <select class="form-select" formControlName="billbacksAllowed">
                <option [ngValue]="false">No</option>
                <option [ngValue]="true">Yes</option>
              </select>
            </div>
          </div>

          <!-- Info message for special price types -->
          <div class="alert alert-info mt-2 mb-0" *ngIf="isPricingDisabledForProduct(addProductForm)">
            <i class="fas fa-info-circle me-2"></i>
            Pricing fields are disabled for this price type. Only internal notes can be added.
          </div>

          <!-- Row 2a: Allowance, Commercial DEL, Commercial FOB, PUA -->
          <div class="row g-2 align-items-end mt-2">
            <div class="col-md-3">
              <label class="form-label">Allowance</label>
              <div class="input-group">
                <span class="input-group-text">$</span>
                <input type="number" class="form-control" formControlName="allowance" step="0.0001" min="0">
              </div>
            </div>
            <div class="col-md-3">
              <label class="form-label">Commercial DEL</label>
              <div class="input-group">
                <span class="input-group-text">$</span>
                <input type="number" class="form-control" formControlName="commercialDelPrice" step="0.01" min="0">
              </div>
            </div>
            <div class="col-md-3">
              <label class="form-label">Commercial FOB</label>
              <div class="input-group">
                <span class="input-group-text">$</span>
                <input type="number" class="form-control" formControlName="commercialFobPrice" step="0.01" min="0">
              </div>
            </div>
            <div class="col-md-3">
              <label class="form-label">Pickup Allowance (PUA)</label>
              <div class="input-group">
                <span class="input-group-text">$</span>
                <input type="number" class="form-control" formControlName="pua" step="0.01" min="0">
              </div>
            </div>
          </div>

          <!-- Row 2b: Fee for Service, NOI -->
          <div class="row g-2 align-items-end mt-2">
            <div class="col">
              <label class="form-label">Fee for Service</label>
              <div class="input-group">
                <span class="input-group-text">$</span>
                <input type="number" class="form-control" formControlName="ffsPrice" step="0.01" min="0">
              </div>
            </div>
            <div class="col">
              <label class="form-label">NOI</label>
              <select class="form-select" formControlName="noiPrice">
                <option [ngValue]="null">Select</option>
                <option [ngValue]="true">Y</option>
                <option [ngValue]="false">N</option>
              </select>
            </div>
          </div>

          <!-- Notes -->
          <div class="row g-2 mt-3">
            <div [ngClass]="isManufacturerUser() ? 'col-12' : 'col-12 col-lg-6'">
              <label class="form-label">{{ isManufacturerUser() ? 'Notes' : 'Manufacturer Notes' }}</label>
              <input type="text" class="form-control" formControlName="manufacturerNotes" maxlength="1000">
            </div>
            <div class="col-12 col-lg-6" *ngIf="!isManufacturerUser()">
              <label class="form-label">Internal Notes</label>
              <input type="text" class="form-control" formControlName="internalNotes" maxlength="1000">
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-denim" (click)="cancelAddProductModal()">Cancel</button>
        <button type="button" class="btn btn-denim" (click)="confirmAddProduct()">
          <i class="fas fa-plus me-1"></i>Add Product
        </button>
      </div>
    </div>
  </div>
</div>
<div *ngIf="showAddProductModal" class="modal-backdrop fade show"></div>

<!-- Product Search Modal (for Add Product) -->
<app-product-search-modal
  [visible]="showProductSearchForAdd"
  [selectionMode]="'single'"
  [manufacturerId]="form.get('manufacturerId')?.value"
  (selectProduct)="onAddProductSelected($event)"
  (closeModal)="showProductSearchForAdd = false">
</app-product-search-modal>
