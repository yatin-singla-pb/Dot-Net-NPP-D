<div class="container py-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="m-0">Batch Proposal Upload</h2>
    <button type="button" class="btn btn-secondary" (click)="onCancel()">
      <i class="fas fa-arrow-left me-2"></i>Back to Proposals
    </button>
  </div>

  <!-- Instructions -->
  <div class="alert alert-info" role="alert">
    <i class="fas fa-info-circle me-2"></i>
    <strong>Batch Upload Instructions:</strong> 
    Upload a CSV file containing proposal data. Each row can represent a product within a proposal. 
    Proposals with the same title, type, and manufacturer will be grouped together.
  </div>

  <!-- Error Alert -->
  <div *ngIf="error" class="alert alert-danger" role="alert">
    <i class="fas fa-exclamation-triangle me-2"></i>{{ error }}
  </div>

  <div class="row">
    <div class="col-lg-8">
      <!-- File Upload -->
      <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Upload CSV File</h5>
          <button type="button" class="btn btn-sm btn-outline-primary" (click)="downloadTemplate()">
            <i class="fas fa-download me-1"></i>Download Template
          </button>
        </div>
        <div class="card-body">
          <form [formGroup]="form">
            <div class="mb-3">
              <label for="csvFile" class="form-label">Select CSV File</label>
              <input 
                type="file" 
                class="form-control" 
                id="csvFile"
                accept=".csv"
                (change)="onFileSelected($event)">
              <div class="form-text">
                Upload a CSV file with proposal data. Use the template above for the correct format.
              </div>
            </div>
          </form>

          <!-- Loading State -->
          <div *ngIf="loading" class="text-center py-3">
            <div class="spinner-border spinner-border-sm me-2"></div>
            Parsing CSV file...
          </div>
        </div>
      </div>

      <!-- Preview -->
      <div class="card mb-4" *ngIf="parsedProposals.length > 0">
        <div class="card-header">
          <h5 class="mb-0">Preview ({{ parsedProposals.length }} proposals)</h5>
        </div>
        <div class="card-body">
          <!-- Valid Proposals -->
          <div *ngIf="getValidProposals().length > 0">
            <h6 class="text-success">
              <i class="fas fa-check-circle me-2"></i>Valid Proposals ({{ getValidProposals().length }})
            </h6>
            <div class="table-responsive mb-4">
              <table class="table table-sm">
                <thead class="table-light">
                  <tr>
                    <th>Title</th>
                    <th>Type ID</th>
                    <th>Manufacturer ID</th>
                    <th>Products</th>
                    <th>Start Date</th>
                    <th>End Date</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let proposal of getValidProposals()">
                    <td>{{ proposal.title }}</td>
                    <td>{{ proposal.proposalTypeId }}</td>
                    <td>{{ proposal.manufacturerId || 'N/A' }}</td>
                    <td>{{ proposal.products.length }}</td>
                    <td>{{ proposal.startDate || 'N/A' }}</td>
                    <td>{{ proposal.endDate || 'N/A' }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Invalid Proposals -->
          <div *ngIf="getInvalidProposals().length > 0">
            <h6 class="text-danger">
              <i class="fas fa-exclamation-triangle me-2"></i>Invalid Proposals ({{ getInvalidProposals().length }})
            </h6>
            <div class="alert alert-warning">
              The following proposals have missing required fields and will be skipped:
            </div>
            <div class="table-responsive">
              <table class="table table-sm">
                <thead class="table-light">
                  <tr>
                    <th>Title</th>
                    <th>Type ID</th>
                    <th>Products</th>
                    <th>Issues</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let proposal of getInvalidProposals()" class="table-warning">
                    <td>{{ proposal.title || 'Missing' }}</td>
                    <td>{{ proposal.proposalTypeId || 'Missing' }}</td>
                    <td>{{ proposal.products.length }}</td>
                    <td>
                      <span *ngIf="!proposal.title" class="badge bg-danger me-1">No Title</span>
                      <span *ngIf="!proposal.proposalTypeId" class="badge bg-danger me-1">No Type</span>
                      <span *ngIf="proposal.products.length === 0" class="badge bg-danger me-1">No Products</span>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Progress -->
      <div class="card mb-4" *ngIf="progress.isProcessing || progress.isComplete">
        <div class="card-header">
          <h5 class="mb-0">Processing Progress</h5>
        </div>
        <div class="card-body">
          <div class="progress mb-3">
            <div 
              class="progress-bar" 
              [class.progress-bar-striped]="progress.isProcessing"
              [class.progress-bar-animated]="progress.isProcessing"
              [style.width.%]="getProgressPercentage()">
              {{ getProgressPercentage() }}%
            </div>
          </div>

          <div class="row text-center">
            <div class="col-3">
              <h6 class="text-primary">{{ progress.total }}</h6>
              <small class="text-muted">Total</small>
            </div>
            <div class="col-3">
              <h6 class="text-info">{{ progress.processed }}</h6>
              <small class="text-muted">Processed</small>
            </div>
            <div class="col-3">
              <h6 class="text-success">{{ progress.successful }}</h6>
              <small class="text-muted">Successful</small>
            </div>
            <div class="col-3">
              <h6 class="text-danger">{{ progress.failed }}</h6>
              <small class="text-muted">Failed</small>
            </div>
          </div>

          <!-- Errors -->
          <div *ngIf="progress.errors.length > 0" class="mt-3">
            <h6 class="text-danger">Errors:</h6>
            <div class="alert alert-danger">
              <ul class="mb-0">
                <li *ngFor="let error of progress.errors">{{ error }}</li>
              </ul>
            </div>
          </div>

          <!-- Completion Message -->
          <div *ngIf="progress.isComplete" class="mt-3">
            <div class="alert alert-success" *ngIf="progress.failed === 0">
              <i class="fas fa-check-circle me-2"></i>
              All proposals have been successfully created!
            </div>
            <div class="alert alert-warning" *ngIf="progress.failed > 0 && progress.successful > 0">
              <i class="fas fa-exclamation-triangle me-2"></i>
              {{ progress.successful }} proposals created successfully, {{ progress.failed }} failed.
            </div>
            <div class="alert alert-danger" *ngIf="progress.successful === 0 && progress.failed > 0">
              <i class="fas fa-times-circle me-2"></i>
              All proposals failed to create. Please check the errors above.
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
      <!-- Actions -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">Actions</h5>
        </div>
        <div class="card-body">
          <div class="d-grid gap-2">
            <button 
              type="button" 
              class="btn btn-primary" 
              (click)="processBatch()" 
              [disabled]="getValidProposals().length === 0 || progress.isProcessing">
              <span *ngIf="progress.isProcessing" class="spinner-border spinner-border-sm me-2"></span>
              <i *ngIf="!progress.isProcessing" class="fas fa-upload me-2"></i>
              {{ progress.isProcessing ? 'Processing...' : 'Process Batch' }}
            </button>
            
            <button 
              type="button" 
              class="btn btn-secondary" 
              (click)="resetBatch()" 
              [disabled]="progress.isProcessing">
              <i class="fas fa-redo me-2"></i>Reset
            </button>
            
            <button 
              type="button" 
              class="btn btn-outline-secondary" 
              (click)="onCancel()" 
              [disabled]="progress.isProcessing">
              Cancel
            </button>
          </div>
        </div>
      </div>

      <!-- Summary -->
      <div class="card mb-4" *ngIf="parsedProposals.length > 0">
        <div class="card-header">
          <h5 class="mb-0">Summary</h5>
        </div>
        <div class="card-body">
          <div class="row text-center">
            <div class="col-6">
              <div class="border-end">
                <h4 class="text-success mb-0">{{ getValidProposals().length }}</h4>
                <small class="text-muted">Valid</small>
              </div>
            </div>
            <div class="col-6">
              <h4 class="text-danger mb-0">{{ getInvalidProposals().length }}</h4>
              <small class="text-muted">Invalid</small>
            </div>
          </div>
        </div>
      </div>

      <!-- CSV Format Help -->
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">CSV Format</h5>
        </div>
        <div class="card-body">
          <p class="small">Required columns:</p>
          <ul class="small">
            <li><strong>title</strong> - Proposal title</li>
            <li><strong>proposalTypeId</strong> - Type ID (1=NewContract, 2=Amendment)</li>
            <li><strong>productId</strong> - Product ID</li>
          </ul>
          
          <p class="small">Optional columns:</p>
          <ul class="small">
            <li>manufacturerId, startDate, endDate</li>
            <li>priceTypeId, proposedPrice, quantity</li>
            <li>distributorIds, industryIds, opcoIds (semicolon-separated)</li>
          </ul>
          
          <button type="button" class="btn btn-sm btn-outline-primary w-100" (click)="downloadTemplate()">
            <i class="fas fa-download me-1"></i>Download Template
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
