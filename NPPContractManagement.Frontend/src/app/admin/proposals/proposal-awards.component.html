<div class="container py-3" *ngIf="!loading && proposal as p">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <a [routerLink]="['/admin/proposals', p.id]" class="text-decoration-none">
        <i class="fas fa-arrow-left me-2"></i>Back to Proposal
      </a>
      <h3 class="mb-0 mt-2">Review & Awards for: <span class="text-primary">{{ p.title }}</span></h3>
      <small class="text-muted">ID #{{ p.id }} • {{ p.startDate | date:'MM/dd/yyyy' }} - {{ p.endDate | date:'MM/dd/yyyy' }}</small>
      <div class="mt-2 small">
        <span class="badge bg-success me-2">Accepted {{ acceptedSelectedCount }}</span>
        <span class="badge bg-danger me-2">Rejected {{ rejectedSelectedCount }}</span>
      </div>
    </div>
    <div class="d-flex gap-2">
      <button class="btn btn-primary" (click)="openProposalHistoryModal()">
        <i class="fas fa-history me-2"></i>View Edit History
      </button>
      <button class="btn btn-outline-secondary" (click)="clearSelections()">
        <i class="fas fa-eraser me-2"></i>Clear
      </button>
      <button class="btn btn-outline-danger" (click)="selectAll('Rejected')">
        <i class="fas fa-times me-2"></i>Reject all
      </button>
      <button class="btn btn-outline-success" (click)="selectAll('Accepted')">
        <i class="fas fa-check me-2"></i>Accept all
      </button>
    </div>
  </div>

  <div *ngIf="error" class="alert alert-danger">
    <i class="fas fa-exclamation-circle me-2"></i>{{ error }}
    <div *ngIf="conflictDetails.length" class="mt-2">
      <strong>Conflicting Contracts:</strong>
      <ul class="mb-0 mt-1">
        <li *ngFor="let c of conflictDetails">
          <a [routerLink]="['/admin/contracts/edit', c.contractId]">{{ c.contractName }}</a>
          <span *ngIf="c.products.length" class="text-muted ms-1">({{ c.products.join(', ') }})</span>
        </li>
      </ul>
      <small class="text-muted mt-1 d-block">Suspend or resolve the conflicting contracts above, then try again.</small>
    </div>
  </div>
  <div *ngIf="success" class="alert alert-success"><i class="fas fa-check-circle me-2"></i>{{ success }}</div>

  <div class="row g-3">
    <div class="col-12">
      <div class="card">
        <div class="card-header d-flex align-items-center justify-content-between">
          <h5 class="mb-0">Products ({{ p.products.length }})</h5>
        </div>
        <div class="card-body">
          <!-- Search and Filter Controls -->
          <div class="row g-3 mb-3" *ngIf="p.products.length > 0">
            <div class="col-md-4">
              <input
                type="text"
                class="form-control"
                [(ngModel)]="productSearchTerm"
                [ngModelOptions]="{standalone: true}"
                (ngModelChange)="onProductSearch($event)">
            </div>
            <div class="col-md-3">
              <select
                class="form-select"
                [(ngModel)]="productFilterPriceType"
                [ngModelOptions]="{standalone: true}"
                (ngModelChange)="onPriceTypeFilter($event)">
                <option [ngValue]="null">All Price Types</option>
                <option *ngFor="let pt of priceTypes" [ngValue]="pt.id">{{ pt.name }}</option>
              </select>
            </div>
            <div class="col-md-3">
              <select
                class="form-select"
                [(ngModel)]="productFilterStatus"
                [ngModelOptions]="{standalone: true}"
                (ngModelChange)="onStatusFilter($event)">
                <option [ngValue]="null">All Statuses</option>
                <option *ngFor="let status of productStatuses" [ngValue]="status.id">{{ status.name }}</option>
              </select>
            </div>
            <div class="col-md-2">
              <button type="button" class="btn btn-outline-secondary w-100" (click)="clearFiltersOnly()">
                <i class="fas fa-times me-1"></i>Clear
              </button>
            </div>
          </div>

          <div *ngIf="p.products.length === 0" class="text-center py-4 text-muted">
            <i class="fas fa-box-open fa-2x mb-2"></i>
            <p>No products in this proposal.</p>
          </div>

          <div *ngIf="p.products.length > 0 && totalProducts === 0" class="text-center py-4 text-muted">
            <i class="fas fa-search fa-2x mb-2"></i>
            <p>No products match your filters.</p>
          </div>

          <!-- Summary badges -->
          <div class="mb-3" *ngIf="p.products.length > 0 && totalProducts > 0">
            <span class="badge bg-success me-2">Accepted {{ acceptedCountIncludingExisting }}</span>
            <span class="badge bg-danger me-2">Rejected {{ rejectedCountIncludingExisting }}</span>
            <span class="badge bg-warning text-dark">Pending {{ pendingCountIncludingExisting }}</span>
          </div>

          <!-- Product Cards -->
          <div *ngFor="let prod of paginatedProducts" class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-start">
              <div class="flex-grow-1 me-3" style="min-width: 0;">
                <ng-container *ngIf="getProductById(prod.productId) as product; else fallbackTitle">
                  <!-- Row 1: Product Code - Brand - Pack - Name -->
                  <div class="text-truncate" [title]="getProductHeaderTitle(prod.productId)">
                    <strong>{{ product.manufacturerProductCode || 'N/A' }}</strong>
                    <span *ngIf="product.brand"> - {{ product.brand }}</span>
                    <span *ngIf="product.packSize"> - {{ product.packSize }}</span>
                    <span *ngIf="product.name || product.description"> - {{ product.name || product.description }}</span>
                  </div>
                  <!-- Row 2: GTIN & Notes with Icons -->
                  <div class="text-muted small mt-1 text-truncate">
                    <span *ngIf="product.gtin" class="me-3" [title]="'GTIN: ' + product.gtin">
                      <i class="fas fa-barcode me-1"></i>{{ product.gtin }}
                    </span>
                    <span *ngIf="product.notes" [title]="'Notes: ' + product.notes">
                      <i class="fas fa-sticky-note me-1"></i>{{ product.notes }}
                    </span>
                  </div>
                </ng-container>
                <ng-template #fallbackTitle>
                  <div><strong>{{ getProductName(prod.productId) }}</strong></div>
                </ng-template>
              </div>
              <div class="d-flex align-items-center gap-2 flex-shrink-0">
                <button type="button" class="btn btn-sm btn-primary" (click)="openHistoricalPricingModal(prod)">
                  <i class="fas fa-history me-1"></i>History
                </button>
                <ng-container *ngIf="getProductById(prod.productId) as product">
                  <span *ngIf="product.status" class="badge" [ngClass]="getProductStatusBadgeClass(product.status)" [title]="'Master Product Status: ' + product.status">
                    {{ product.status }}
                  </span>
                </ng-container>
                <span class="badge" [ngClass]="statusBadgeClass(getProductStatusName(prod.productProposalStatusId || null))">
                  {{ getProductStatusName(prod.productProposalStatusId || null) || 'Pending' }}
                </span>
              </div>
            </div>
            <div class="card-body p-3">
              <!-- Row 1: Price Type, UOM, Quantity, Billbacks -->
              <div class="row g-2 align-items-end">
                <div class="col-md-3">
                  <label class="form-label">Price Type</label>
                  <select class="form-select" [(ngModel)]="prod.priceTypeId" [ngModelOptions]="{standalone: true}">
                    <option [ngValue]="null">Select Type</option>
                    <option *ngFor="let pt of priceTypes" [ngValue]="pt.id">{{ pt.name }}</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label class="form-label">UOM</label>
                  <select class="form-select" [(ngModel)]="prod.uom" [ngModelOptions]="{standalone: true}">
                    <option [ngValue]="null">Select</option>
                    <option *ngFor="let u of uoms" [ngValue]="u">{{ u }}</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label class="form-label">Quantity</label>
                  <input type="number" class="form-control" [(ngModel)]="prod.quantity" [ngModelOptions]="{standalone: true}" min="1">
                </div>
                <div class="col-md-3">
                  <label class="form-label">Billbacks</label>
                  <select class="form-select" [(ngModel)]="prod.billbacksAllowed" [ngModelOptions]="{standalone: true}">
                    <option [ngValue]="false">No</option>
                    <option [ngValue]="true">Yes</option>
                  </select>
                </div>
              </div>

              <!-- Row 2: Allowance, Commercial DEL, Commercial FOB, PUA -->
              <div class="row g-2 align-items-end mt-2">
                <div class="col-md-3">
                  <label class="form-label">Allowance</label>
                  <div class="input-group">
                    <span class="input-group-text">$</span>
                    <input type="number" step="0.0001" class="form-control" [(ngModel)]="prod.allowance" [ngModelOptions]="{standalone: true}" min="0" [disabled]="isAllowanceDisabled(prod)" (ngModelChange)="onAllowanceChange(prod)">
                  </div>
                </div>
                <div class="col-md-3">
                  <label class="form-label">Commercial DEL</label>
                  <div class="input-group">
                    <span class="input-group-text">$</span>
                    <input type="number" step="0.01" class="form-control" [(ngModel)]="prod.commercialDelPrice" [ngModelOptions]="{standalone: true}" min="0" [disabled]="isPricingDisabled(prod)" (ngModelChange)="onPricingFieldChange(prod)">
                  </div>
                </div>
                <div class="col-md-3">
                  <label class="form-label">Commercial FOB</label>
                  <div class="input-group">
                    <span class="input-group-text">$</span>
                    <input type="number" step="0.01" class="form-control" [(ngModel)]="prod.commercialFobPrice" [ngModelOptions]="{standalone: true}" min="0" [disabled]="isPricingDisabled(prod)" (ngModelChange)="onPricingFieldChange(prod)">
                  </div>
                </div>
                <div class="col-md-3">
                  <label class="form-label">Pickup Allowance (PUA)</label>
                  <div class="input-group">
                    <span class="input-group-text">$</span>
                    <input type="number" step="0.01" class="form-control" [(ngModel)]="prod.pua" [ngModelOptions]="{standalone: true}" min="0" [disabled]="isPricingDisabled(prod)" (ngModelChange)="onPricingFieldChange(prod)">
                  </div>
                </div>
              </div>

              <!-- Row 3: FFS, NOI (Y/N), PTV -->
              <div class="row g-2 align-items-end mt-2">
                <div class="col">
                  <label class="form-label">Fee for Service</label>
                  <div class="input-group">
                    <span class="input-group-text">$</span>
                    <input type="number" step="0.01" class="form-control" [(ngModel)]="prod.ffsPrice" [ngModelOptions]="{standalone: true}" min="0" [disabled]="isPricingDisabled(prod)" (ngModelChange)="onPricingFieldChange(prod)">
                  </div>
                </div>
                <div class="col">
                  <label class="form-label">NOI</label>
                  <select class="form-select" [(ngModel)]="prod.noiPrice" [ngModelOptions]="{standalone: true}" [disabled]="isPricingDisabled(prod)" (ngModelChange)="onPricingFieldChange(prod)">
                    <option [ngValue]="null">Select</option>
                    <option [ngValue]="true">Y</option>
                    <option [ngValue]="false">N</option>
                  </select>
                </div>
                <div class="col">
                  <label class="form-label">PTV</label>
                  <div class="input-group">
                    <span class="input-group-text">$</span>
                    <input type="number" step="0.01" class="form-control" [(ngModel)]="prod.ptv" [ngModelOptions]="{standalone: true}" min="0" [disabled]="isPricingDisabled(prod)" (ngModelChange)="onPricingFieldChange(prod)">
                  </div>
                </div>
              </div>

              <!-- Notes -->
              <div class="row g-2 mt-3">
                <div class="col-12 col-lg-6">
                  <label class="form-label">Manufacturer Notes</label>
                  <input type="text" class="form-control" [(ngModel)]="prod.manufacturerNotes" [ngModelOptions]="{standalone: true}" maxlength="1000">
                </div>
                <div class="col-12 col-lg-6">
                  <label class="form-label">Internal Notes</label>
                  <input type="text" class="form-control" [(ngModel)]="prod.internalNotes" [ngModelOptions]="{standalone: true}" maxlength="1000">
                </div>
              </div>

              <!-- Selection Buttons -->
              <div class="d-flex justify-content-end mt-3">
                <div class="btn-group" role="group">
                  <input type="radio" class="btn-check" name="sel-{{prod.productId}}" id="sel-a-{{prod.productId}}" [checked]="selections[prod.productId] === 'Accepted'" (click)="selections[prod.productId] = 'Accepted'">
                  <label class="btn btn-outline-success btn-sm" for="sel-a-{{prod.productId}}"><i class="fas fa-check me-1"></i> Accept</label>

                  <input type="radio" class="btn-check" name="sel-{{prod.productId}}" id="sel-r-{{prod.productId}}" [checked]="selections[prod.productId] === 'Rejected'" (click)="selections[prod.productId] = 'Rejected'">
                  <label class="btn btn-outline-danger btn-sm" for="sel-r-{{prod.productId}}"><i class="fas fa-times me-1"></i> Reject</label>

                  <input type="radio" class="btn-check" name="sel-{{prod.productId}}" id="sel-n-{{prod.productId}}" [checked]="!selections[prod.productId]" (click)="selections[prod.productId] = null">
                  <label class="btn btn-outline-secondary btn-sm" for="sel-n-{{prod.productId}}">Clear</label>
                </div>
              </div>
            </div>
          </div>

          <!-- Pagination Controls -->
          <div class="d-flex flex-row-reverse mt-3" *ngIf="p.products.length > 0 && totalProducts > 0">
            <ul class="pagination pagination-sm mb-0">
              <li class="page-item" [class.disabled]="currentPage === 1">
                <a href="#" class="page-link" (click)="onPageChange(1); $event.preventDefault()">&lt;&lt;</a>
              </li>
              <li class="page-item" [class.disabled]="currentPage === 1">
                <a href="#" class="page-link" (click)="onPageChange(currentPage - 1); $event.preventDefault()">&lt;</a>
              </li>
              <li
                *ngFor="let page of getPageNumbers()"
                class="page-item"
                [class.active]="page === currentPage"
                [class.disabled]="page === -1">
                <a
                  href="#"
                  class="page-link"
                  (click)="page !== -1 ? onPageChange(page) : null; $event.preventDefault()">
                  {{page === -1 ? '...' : page}}
                </a>
              </li>
              <li class="page-item" [class.disabled]="currentPage === totalPages">
                <a href="#" class="page-link" (click)="onPageChange(currentPage + 1); $event.preventDefault()">&gt;</a>
              </li>
              <li class="page-item" [class.disabled]="currentPage === totalPages">
                <a href="#" class="page-link" (click)="onPageChange(totalPages); $event.preventDefault()">&gt;&gt;</a>
              </li>
            </ul>

            <div class="me-5 align-self-center">
              <span>{{ ((currentPage - 1) * pageSize) + 1 }} to {{ Math.min(currentPage * pageSize, totalProducts) }} of {{ totalProducts }}</span>
            </div>

            <div class="me-5 align-self-center">
              <label class="form-label m-0" for="pageSize">Rows per page:</label>
              <select
                class="m-0 p-0 border-top-0 border-start-0 border-end-0 border-bottom-1"
                [(ngModel)]="pageSize"
                [ngModelOptions]="{standalone: true}"
                (ngModelChange)="onPageSizeChange($event)"
                name="pageSize">
                <option [ngValue]="1">1</option>
                <option [ngValue]="5">5</option>
                <option [ngValue]="10">10</option>
                <option [ngValue]="25">25</option>
                <option [ngValue]="50">50</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="d-flex justify-content-end gap-2 mt-3">
    <button class="btn btn-secondary" [routerLink]="['/admin/proposals', p.id]">Cancel</button>
    <button class="btn btn-primary" (click)="submitAward()" [disabled]="loading">
      <span *ngIf="loading" class="spinner-border spinner-border-sm me-2"></span>
      Submit Awards
    </button>
  </div>
</div>

<div *ngIf="loading" class="text-center py-5">
  <div class="spinner-border text-primary"></div>
  <p class="mt-2">Loading...</p>
</div>

<!-- Historical Pricing Modal -->
<div class="modal fade show d-block" *ngIf="showHistoricalPricingModal" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-history me-2"></i>Historical Pricing - {{ getProductName(selectedProductForHistory?.productId) }}
        </h5>
        <button type="button" class="btn-close" (click)="closeHistoricalPricingModal()"></button>
      </div>
      <div class="modal-body">
        <div *ngIf="historicalPricing.length === 0" class="text-center py-4 text-muted">
          <i class="fas fa-info-circle fa-2x mb-2"></i>
          <p>No historical pricing data available for this product.</p>
        </div>

        <div *ngIf="historicalPricing.length > 0" class="table-responsive">
          <table class="table table-sm table-hover">
            <thead class="table-light">
              <tr>
                <th>Contract</th>
                <th>Start Date</th>
                <th>End Date</th>
                <th>Price Type</th>
                <th class="text-end">Commercial FOB</th>
                <th class="text-end">Commercial DEL</th>
                <th class="text-end">Allowance</th>
                <th class="text-end">PUA</th>
                <th class="text-end">FFS</th>
                <th class="text-end">NOI</th>
                <th class="text-end">PTV</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of historicalPricing">
                <td>
                  <strong>{{ item.contractTitle || 'N/A' }}</strong>
                  <div class="text-muted small">ID: {{ item.contractId }}</div>
                </td>
                <td>{{ item.startDate | date:'MM/dd/yyyy' }}</td>
                <td>{{ item.endDate | date:'MM/dd/yyyy' }}</td>
                <td>{{ item.priceTypeName || 'N/A' }}</td>
                <td class="text-end">{{ formatCurrencyUSD(item.commercialFobPrice) }}</td>
                <td class="text-end">{{ formatCurrencyUSD(item.commercialDelPrice) }}</td>
                <td class="text-end">{{ formatCurrencyUSD(item.allowance) }}</td>
                <td class="text-end">{{ formatCurrencyUSD(item.pua) }}</td>
                <td class="text-end">{{ formatCurrencyUSD(item.ffsPrice) }}</td>
                <td class="text-end">{{ formatCurrencyUSD(item.noiPrice) }}</td>
                <td class="text-end">{{ formatCurrencyUSD(item.ptv) }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeHistoricalPricingModal()">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Approve Confirmation Modal -->
<div class="modal fade show d-block" *ngIf="showApproveConfirmModal" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-check-circle me-2 text-success"></i>Confirm Award Submission</h5>
        <button type="button" class="btn-close" (click)="cancelApproveConfirm()"></button>
      </div>
      <div class="modal-body">
        <p>You are about to create a contract from this proposal with the following selections:</p>
        <ul class="list-unstyled">
          <li><span class="badge bg-success me-2">{{ acceptedCountIncludingExisting }}</span> Accepted product(s) will be added to the contract</li>
          <li class="mt-1"><span class="badge bg-danger me-2">{{ rejectedCountIncludingExisting }}</span> Rejected product(s)</li>
          <li class="mt-1"><span class="badge bg-warning text-dark me-2">{{ pendingCountIncludingExisting }}</span> Pending product(s)</li>
        </ul>
        <div class="form-check mt-3">
          <input type="checkbox" class="form-check-input" [(ngModel)]="openAfterCreation" [ngModelOptions]="{standalone: true}" id="openAfterCreation">
          <label class="form-check-label" for="openAfterCreation">Open contract after creation</label>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="cancelApproveConfirm()">Cancel</button>
        <button type="button" class="btn btn-success" (click)="proceedApproveSelected()" [disabled]="saving">
          <span *ngIf="saving" class="spinner-border spinner-border-sm me-2"></span>
          Confirm & Create Contract
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Reject All Modal -->
<div class="modal fade show d-block" *ngIf="showRejectAllModal" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fas fa-times-circle me-2 text-danger"></i>Reject Proposal</h5>
        <button type="button" class="btn-close" (click)="cancelRejectAll()"></button>
      </div>
      <div class="modal-body">
        <p>No products have been accepted. This will reject the entire proposal.</p>
        <div class="mb-3">
          <label class="form-label">Rejection Reason (optional)</label>
          <textarea class="form-control" rows="3" [(ngModel)]="rejectReason" [ngModelOptions]="{standalone: true}"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="cancelRejectAll()">Cancel</button>
        <button type="button" class="btn btn-danger" (click)="confirmRejectAll()" [disabled]="saving">
          <span *ngIf="saving" class="spinner-border spinner-border-sm me-2"></span>
          Reject Proposal
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Proposal Edit History Modal -->
<div class="modal fade show d-block" *ngIf="showProposalHistoryModal" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-history me-2"></i>Proposal Edit History - {{ proposal?.title }}
        </h5>
        <button type="button" class="btn-close" (click)="closeProposalHistoryModal()"></button>
      </div>
      <div class="modal-body">
        <div *ngIf="proposalEditHistory.length === 0" class="text-center py-4 text-muted">
          <i class="fas fa-info-circle fa-2x mb-2"></i>
          <p>No edit history available for this proposal.</p>
        </div>

        <div *ngIf="proposalEditHistory.length > 0" class="table-responsive">
          <table class="table table-sm table-hover">
            <thead class="table-light">
              <tr>
                <th>Date/Time</th>
                <th>User</th>
                <th>Product</th>
                <th>Change Type</th>
                <th>Previous Values</th>
                <th>Current Values</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of proposalEditHistory">
                <td>{{ item.changedDate | date:'MM/dd/yyyy HH:mm:ss' }}</td>
                <td>
                  <strong>{{ item.changedBy || 'N/A' }}</strong>
                </td>
                <td>
                  <strong>{{ item.productName || 'N/A' }}</strong>
                  <div class="text-muted small">ID: {{ item.productId }}</div>
                </td>
                <td>
                  <span class="badge" [ngClass]="{
                    'bg-success': item.changeType === 'Created',
                    'bg-info': item.changeType === 'Updated',
                    'bg-danger': item.changeType === 'Deleted'
                  }">
                    {{ item.changeType || 'N/A' }}
                  </span>
                </td>
                <td>
                  <pre class="mb-0 small" style="max-width: 300px; overflow-x: auto;">{{ item.previousJson || '—' }}</pre>
                </td>
                <td>
                  <pre class="mb-0 small" style="max-width: 300px; overflow-x: auto;">{{ item.currentJson || '—' }}</pre>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeProposalHistoryModal()">Close</button>
      </div>
    </div>
  </div>
</div>
