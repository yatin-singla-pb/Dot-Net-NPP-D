<div class="container mt-4">
  <h2>Velocity Data Exceptions</h2>
  <p class="text-muted">View and analyze failed velocity import rows</p>

  <!-- Filters -->
  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">Filters</h5>
      <div class="row">
        <div class="col-md-3">
          <label for="jobId" class="form-label">Job ID</label>
          <input
            type="number"
            id="jobId"
            class="form-control"
            [(ngModel)]="jobId"
            (change)="onFilterChange()"
            placeholder="Filter by Job ID"
          />
        </div>
        <div class="col-md-3">
          <label for="startDate" class="form-label">Start Date</label>
          <input
            type="date"
            id="startDate"
            class="form-control"
            [(ngModel)]="startDate"
            [class.has-value]="startDate"
            (change)="onFilterChange()"
          />
        </div>
        <div class="col-md-3">
          <label for="endDate" class="form-label">End Date</label>
          <input
            type="date"
            id="endDate"
            class="form-control"
            [(ngModel)]="endDate"
            [class.has-value]="endDate"
            (change)="onFilterChange()"
          />
        </div>
        <div class="col-md-3">
          <label for="keyword" class="form-label">Keyword</label>
          <input
            type="text"
            id="keyword"
            class="form-control"
            [(ngModel)]="keyword"
            (keyup.enter)="onFilterChange()"
            placeholder="Search errors..."
          />
        </div>
      </div>
      <div class="row mt-3">
        <div class="col-md-12">
          <button class="btn btn-denim" (click)="onFilterChange()">Apply Filters</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Indicator -->
  <div *ngIf="loading" class="text-center my-4">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>

  <!-- Results -->
  <div *ngIf="!loading">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <strong>Total Exceptions:</strong> {{ totalCount }}
      </div>
      <div>
        <label for="pageSize" class="me-2">Rows per page:</label>
        <select id="pageSize" class="form-select d-inline-block w-auto" [(ngModel)]="pageSize" (change)="onPageSizeChange()">
          <option [value]="25">25</option>
          <option [value]="50">50</option>
          <option [value]="100">100</option>
        </select>
      </div>
    </div>

    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead>
          <tr>
            <th>Job ID</th>
            <th>Row #</th>
            <th>File Name</th>
            <th>Error Message</th>
            <th>Processed At</th>
            <th>Created By</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <ng-container *ngFor="let exception of exceptions">
            <tr>
              <td>{{ exception.jobIdStr }}</td>
              <td>{{ exception.rowIndex + 1 }}</td>
              <td>{{ exception.fileName || 'N/A' }}</td>
              <td>
                <span class="text-danger">{{ exception.errorMessage || 'Unknown error' }}</span>
              </td>
              <td>{{ formatDateTime(exception.processedAt) }}</td>
              <td>{{ exception.createdBy || 'N/A' }}</td>
              <td>
                <span class="badge" [ngClass]="getActionBadgeClass(exception.actionStatus || '')">
                  {{ getActionLabel(exception.actionStatus || '') }}
                </span>
              </td>
              <td>
                <div class="btn-group btn-group-sm">
                  <button
                    class="btn btn-sm btn-outline-primary"
                    (click)="toggleRow(exception.id)"
                  >
                    {{ isRowExpanded(exception.id) ? 'Hide' : 'Show' }}
                  </button>
                  <button
                    *ngIf="!exception.actionStatus"
                    class="btn btn-sm btn-outline-secondary"
                    (click)="dismissException(exception)"
                    title="Dismiss this exception"
                  >
                    Dismiss
                  </button>
                  <button
                    *ngIf="!exception.actionStatus"
                    class="btn btn-sm btn-outline-info"
                    (click)="markAsNewContract(exception)"
                    title="Flag for new contract"
                  >
                    New Contract
                  </button>
                  <button
                    *ngIf="!exception.actionStatus"
                    class="btn btn-sm btn-outline-warning"
                    (click)="markAsAmendment(exception)"
                    title="Flag for contract amendment"
                  >
                    Amendment
                  </button>
                </div>
              </td>
            </tr>
            <tr *ngIf="isRowExpanded(exception.id)">
              <td colspan="8">
                <div class="p-3 bg-light">
                  <div class="row">
                    <div class="col-md-6">
                      <h6>Raw Data:</h6>
                      <pre class="bg-white p-2 border rounded">{{ exception.rawData || 'No raw data available' }}</pre>
                    </div>
                    <div class="col-md-6" *ngIf="exception.actionStatus">
                      <h6>Action Details:</h6>
                      <table class="table table-sm">
                        <tr><th>Action</th><td>{{ exception.actionStatus }}</td></tr>
                        <tr><th>Notes</th><td>{{ exception.actionNotes || 'None' }}</td></tr>
                        <tr><th>Taken By</th><td>{{ exception.actionTakenBy || 'N/A' }}</td></tr>
                        <tr><th>Taken At</th><td>{{ exception.actionTakenAt ? formatDateTime(exception.actionTakenAt) : 'N/A' }}</td></tr>
                      </table>
                    </div>
                  </div>
                </div>
              </td>
            </tr>
          </ng-container>
          <tr *ngIf="exceptions.length === 0">
            <td colspan="8" class="text-center text-muted">
              No exceptions found
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <nav *ngIf="totalPages > 1" aria-label="Page navigation">
      <ul class="pagination justify-content-center">
        <li class="page-item" [class.disabled]="currentPage === 1">
          <a class="page-link" (click)="onPageChange(currentPage - 1)" href="javascript:void(0)">Previous</a>
        </li>
        <li
          *ngFor="let page of getPaginationPages()"
          class="page-item"
          [class.active]="page === currentPage"
        >
          <a class="page-link" (click)="onPageChange(page)" href="javascript:void(0)">{{ page }}</a>
        </li>
        <li class="page-item" [class.disabled]="currentPage === totalPages">
          <a class="page-link" (click)="onPageChange(currentPage + 1)" href="javascript:void(0)">Next</a>
        </li>
      </ul>
    </nav>
  </div>
</div>

