<main class="container">
  <nav aria-label="breadcrumb" id="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a routerLink="/dashboard">Dashboard</a></li>
      <li class="breadcrumb-item active">Contract Over Term Report</li>
    </ol>
  </nav>

  <h2 class="mb-4">Contract Over Term Report</h2>

  <!-- Filters Card -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="mb-0">Report Filters</h5>
    </div>
    <div class="card-body">
      <div class="row g-3">
        <!-- Point in Time -->
        <div class="col-md-3">
          <label for="pointInTime" class="form-label">Point in Time</label>
          <input
            type="date"
            class="form-control"
            id="pointInTime"
            [(ngModel)]="pointInTime"
            [class.has-value]="pointInTime"
            required>
        </div>

        <!-- Max Terms Back -->
        <div class="col-md-3">
          <label for="maxTermsBack" class="form-label">Max Terms Back</label>
          <input 
            type="number" 
            class="form-control" 
            id="maxTermsBack" 
            [(ngModel)]="maxTermsBack"
            min="1"
            max="10"
            required>
        </div>

        <!-- Contract Number -->
        <div class="col-md-3">
          <label for="contractNumber" class="form-label">Contract Number</label>
          <input 
            type="text" 
            class="form-control" 
            id="contractNumber" 
            [(ngModel)]="contractNumber"
            >
        </div>

        <!-- Manufacturer -->
        <div class="col-md-3">
          <label for="manufacturer" class="form-label">Manufacturer</label>
          <select 
            class="form-select" 
            id="manufacturer" 
            [(ngModel)]="selectedManufacturerId"
            (change)="onManufacturerChange()">
            <option [ngValue]="null">All Manufacturers</option>
            <option *ngFor="let m of manufacturers" [ngValue]="m.id">{{ m.name }}</option>
          </select>
        </div>

        <!-- Product -->
        <div class="col-md-3">
          <label for="product" class="form-label">Product</label>
          <select
            class="form-select"
            id="product"
            [(ngModel)]="selectedProductId">
            <option [ngValue]="null">All Products</option>
            <option *ngFor="let p of products" [ngValue]="p.id">{{ p.manufacturerProductCode }} - {{ p.description }}</option>
          </select>
        </div>

        <!-- OpCo -->
        <div class="col-md-3">
          <label for="opco" class="form-label">Op-Co</label>
          <select 
            class="form-select" 
            id="opco" 
            [(ngModel)]="selectedOpCoId">
            <option [ngValue]="null">All Op-Cos</option>
            <option *ngFor="let o of opCos" [ngValue]="o.id">{{ o.name }}</option>
          </select>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="mt-3 d-flex gap-2">
        <button 
          type="button" 
          class="btn btn-denim" 
          (click)="generateReport()"
          [disabled]="loading">
          <i class="fas fa-search me-2"></i>
          {{ loading ? 'Generating...' : 'Generate Report' }}
        </button>
        <button 
          type="button" 
          class="btn btn-outline-secondary" 
          (click)="downloadExcel()"
          [disabled]="!reportData || downloadingExcel">
          <i class="fas fa-download me-2"></i>
          {{ downloadingExcel ? 'Downloading...' : 'Download Excel' }}
        </button>
      </div>
    </div>
  </div>

  <!-- Error Message -->
  <div *ngIf="error" class="alert alert-danger">
    {{ error }}
  </div>

  <!-- Loading Spinner -->
  <div *ngIf="loading" class="text-center my-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2">Generating report...</p>
  </div>

  <!-- Report Results -->
  <div *ngIf="reportData && !loading" class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0">Report Results ({{ reportData.totalRows }} total rows)</h5>
      <div class="d-flex align-items-center gap-2">
        <label class="mb-0">Rows per page:</label>
        <select class="form-select form-select-sm" [(ngModel)]="pageSize" (change)="onPageSizeChange()" style="width: auto;">
          <option [value]="25">25</option>
          <option [value]="50">50</option>
          <option [value]="100">100</option>
          <option [value]="200">200</option>
        </select>
      </div>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-striped table-hover table-sm">
          <thead class="table-light sticky-top">
            <tr>
              <th>Contract #</th>
              <th>Manufacturer</th>
              <th>Start Date</th>
              <th>End Date</th>
              <th>Op-Cos</th>
              <th>Product Code</th>
              <th>Product Name</th>
              <th>Pricing</th>
              <th>Est. Volume</th>
              <th>Actual Volume</th>
              <th>Industry</th>
              <th>Price Type</th>

              <!-- Previous Terms Headers -->
              <ng-container *ngFor="let termNum of getTermHeaders()">
                <th colspan="5" class="text-center bg-light">Previous Term {{ termNum }}</th>
              </ng-container>
            </tr>
            <tr>
              <th colspan="12"></th>
              <!-- Previous Terms Sub-Headers -->
              <ng-container *ngFor="let termNum of getTermHeaders()">
                <th class="bg-light">Start Date</th>
                <th class="bg-light">End Date</th>
                <th class="bg-light">Pricing</th>
                <th class="bg-light">Est. Volume</th>
                <th class="bg-light">Actual Volume</th>
              </ng-container>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let row of reportData.rows">
              <td>{{ row.contractNumber }}</td>
              <td>{{ row.manufacturer }}</td>
              <td>{{ row.startDate | date:'yyyy-MM-dd' }}</td>
              <td>{{ row.endDate | date:'yyyy-MM-dd' }}</td>
              <td>{{ row.opCos }}</td>
              <td>{{ row.productCode }}</td>
              <td>{{ row.productName }}</td>
              <td>{{ row.pricing | currency }}</td>
              <td>{{ row.estimatedVolume | number:'1.0-2' }}</td>
              <td>{{ row.actualVolume | number:'1.0-2' }}</td>
              <td>{{ row.industry || '-' }}</td>
              <td>{{ row.priceType || '-' }}</td>

              <!-- Previous Terms Data -->
              <ng-container *ngFor="let termNum of getTermHeaders()">
                @if (getPreviousTerm(row, termNum); as term) {
                  <td>{{ term.startDate | date:'yyyy-MM-dd' }}</td>
                  <td>{{ term.endDate | date:'yyyy-MM-dd' }}</td>
                  <td>{{ term.pricing | currency }}</td>
                  <td>{{ term.estimatedVolume | number:'1.0-2' }}</td>
                  <td>{{ term.actualVolume | number:'1.0-2' }}</td>
                } @else {
                  <td>-</td>
                  <td>-</td>
                  <td>-</td>
                  <td>-</td>
                  <td>-</td>
                }
              </ng-container>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- No Results Message -->
      <div *ngIf="reportData.totalRows === 0" class="text-center text-muted py-4">
        <i class="fas fa-info-circle fa-3x mb-3"></i>
        <p>No data found for the selected filters.</p>
      </div>

      <!-- Pagination Controls -->
      <div *ngIf="reportData.totalRows > 0" class="d-flex justify-content-between align-items-center mt-3">
        <div class="text-muted">
          Showing {{ (currentPage - 1) * pageSize + 1 }} to {{ Math.min(currentPage * pageSize, reportData.totalRows) }} of {{ reportData.totalRows }} rows
        </div>
        <nav aria-label="Page navigation">
          <ul class="pagination mb-0">
            <li class="page-item" [class.disabled]="currentPage === 1">
              <a class="page-link" (click)="onPageChange(1)" [class.disabled]="currentPage === 1">
                <i class="fas fa-angle-double-left"></i>
              </a>
            </li>
            <li class="page-item" [class.disabled]="currentPage === 1">
              <a class="page-link" (click)="onPageChange(currentPage - 1)" [class.disabled]="currentPage === 1">
                <i class="fas fa-angle-left"></i>
              </a>
            </li>
            <li class="page-item" *ngFor="let page of getPageNumbers()" [class.active]="page === currentPage">
              <a class="page-link" (click)="onPageChange(page)">{{ page }}</a>
            </li>
            <li class="page-item" [class.disabled]="currentPage === reportData.totalPages">
              <a class="page-link" (click)="onPageChange(currentPage + 1)" [class.disabled]="currentPage === reportData.totalPages">
                <i class="fas fa-angle-right"></i>
              </a>
            </li>
            <li class="page-item" [class.disabled]="currentPage === reportData.totalPages">
              <a class="page-link" (click)="onPageChange(reportData.totalPages)" [class.disabled]="currentPage === reportData.totalPages">
                <i class="fas fa-angle-double-right"></i>
              </a>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  </div>
</main>


