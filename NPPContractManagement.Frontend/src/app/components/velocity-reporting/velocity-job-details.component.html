<main class="container">
  <!-- Breadcrumb -->
  <nav aria-label="breadcrumb" id="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a routerLink="/dashboard">Dashboard</a></li>
      <li class="breadcrumb-item"><a routerLink="/admin/velocity">Velocity Reporting</a></li>
      <li class="breadcrumb-item active">Job {{ jobId }}</li>
    </ol>
  </nav>

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">Velocity Job Details</h2>
    <div class="d-flex gap-2">
      <button class="btn btn-outline-secondary" (click)="goBack()">
        <i class="bi bi-arrow-left"></i> Back
      </button>
      <button class="btn btn-denim" (click)="refresh()">
        <i class="bi bi-arrow-clockwise"></i> Refresh
      </button>
      @if (canRestartJob()) {
        <button
          class="btn btn-denim"
          (click)="restartJob()"
          [disabled]="restarting">
          @if (restarting) {
            <span class="spinner-border spinner-border-sm me-2" role="status"></span>
            Restarting...
          } @else {
            <i class="bi bi-arrow-clockwise me-2"></i>
            Restart Job
          }
        </button>
      }
    </div>
  </div>

  <!-- Restart Success/Error Messages -->
  @if (restartSuccess) {
    <div class="alert alert-success alert-dismissible fade show" role="alert">
      <i class="bi bi-check-circle-fill me-2"></i>
      {{ restartSuccess }}
      <button type="button" class="btn-close" (click)="restartSuccess = null"></button>
    </div>
  }

  @if (restartError) {
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      <i class="bi bi-exclamation-triangle-fill me-2"></i>
      {{ restartError }}
      <button type="button" class="btn-close" (click)="restartError = null"></button>
    </div>
  }

  <!-- Loading State -->
  @if (loading) {
    <div class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-3">Loading job details...</p>
    </div>
  }

  <!-- Error State -->
  @if (error && !loading) {
    <div class="alert alert-danger">
      <i class="bi bi-exclamation-triangle me-2"></i>
      {{ error }}
    </div>
  }

  <!-- Job Details -->
  @if (jobDetails && !loading) {
    <!-- Job Summary Card -->
    <div class="card mb-4">
      <div class="card-header">
        <h5 class="mb-0">Job Summary</h5>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <table class="table table-sm">
              <tbody>
                <tr>
                  <th style="width: 150px;">Job ID:</th>
                  <td><code>{{ jobDetails.jobId }}</code></td>
                </tr>
                <tr>
                  <th>Status:</th>
                  <td>
                    <span [class]="getJobStatusClass(jobDetails.status)">{{ jobDetails.status }}</span>
                    @if (jobDetails.status.toLowerCase() === 'processing' || jobDetails.status.toLowerCase() === 'queued') {
                      <div class="spinner-border spinner-border-sm ms-2" role="status">
                        <span class="visually-hidden">Processing...</span>
                      </div>
                    }
                  </td>
                </tr>
                <tr>
                  <th>File Name:</th>
                  <td>{{ jobDetails.fileName || '-' }}</td>
                </tr>
                <tr>
                  <th>Created By:</th>
                  <td>{{ jobDetails.createdBy || '-' }}</td>
                </tr>
                <tr>
                  <th>Created At:</th>
                  <td>{{ jobDetails.createdAt | date:'medium' }}</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="col-md-6">
            <table class="table table-sm">
              <tbody>
                <tr>
                  <th style="width: 150px;">Total Rows:</th>
                  <td>{{ jobDetails.totalRows }}</td>
                </tr>
                <tr>
                  <th>Success:</th>
                  <td><span class="text-success fw-bold">{{ jobDetails.successRows }}</span></td>
                </tr>
                <tr>
                  <th>Failed:</th>
                  <td><span class="text-danger fw-bold">{{ jobDetails.failedRows }}</span></td>
                </tr>
                <tr>
                  <th>Progress:</th>
                  <td>
                    @if (jobDetails.status.toLowerCase() === 'processing') {
                      <div class="progress" style="height: 25px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated"
                             role="progressbar"
                             [style.width.%]="getProgressPercentage()"
                             [attr.aria-valuenow]="getProgressPercentage()"
                             aria-valuemin="0" aria-valuemax="100">
                          {{ getProgressPercentage() }}%
                        </div>
                      </div>
                    } @else {
                      <span class="text-muted">-</span>
                    }
                  </td>
                </tr>
                <tr>
                  <th>Elapsed Time:</th>
                  <td>{{ getElapsedTime() }}</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        @if (jobDetails.errorMessage) {
          <div class="alert alert-danger mt-3 mb-0">
            <strong>Error:</strong> {{ jobDetails.errorMessage }}
          </div>
        }

        @if (isJobStuck()) {
          <div class="alert alert-warning mt-3 mb-0">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong>Warning:</strong> This job has been processing for over 30 minutes and may be stuck.
            Consider restarting it using the "Restart Job" button above.
          </div>
        }
      </div>
    </div>

    <!-- Row Details Card -->
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Processing Details ({{ totalRows }} rows)</h5>
        <div class="btn-group btn-group-sm" role="group">
          <input type="radio" class="btn-check" name="statusFilter" id="filterAll" value="all" 
                 [checked]="statusFilter === 'all'" (change)="onFilterChange('all')">
          <label class="btn btn-outline-secondary" for="filterAll">All</label>

          <input type="radio" class="btn-check" name="statusFilter" id="filterSuccess" value="success"
                 [checked]="statusFilter === 'success'" (change)="onFilterChange('success')">
          <label class="btn btn-outline-success" for="filterSuccess">Success</label>

          <input type="radio" class="btn-check" name="statusFilter" id="filterFailed" value="failed"
                 [checked]="statusFilter === 'failed'" (change)="onFilterChange('failed')">
          <label class="btn btn-outline-danger" for="filterFailed">Failed</label>
        </div>
      </div>
      <div class="card-body">
        @if (paginatedRows.length === 0) {
          <div class="alert alert-info mb-0">
            <i class="bi bi-info-circle me-2"></i>
            No rows found matching the selected filter.
          </div>
        } @else {
          <div class="table-responsive">
            <table class="table table-hover table-sm">
              <thead>
                <tr>
                  <th style="width: 80px;">Row #</th>
                  <th style="width: 120px;">Status</th>
                  <th>Error Message</th>
                  <th style="width: 150px;">Processed At</th>
                </tr>
              </thead>
              <tbody>
                @for (row of paginatedRows; track row.id) {
                  <tr>
                    <td>{{ row.rowIndex }}</td>
                    <td><span [class]="getStatusClass(row.status)">{{ row.status }}</span></td>
                    <td>
                      @if (row.errorMessage) {
                        <span class="text-danger">{{ row.errorMessage }}</span>
                      } @else {
                        <span class="text-muted">-</span>
                      }
                    </td>
                    <td>{{ row.processedAt | date:'yyyy-MM-dd HH:mm:ss' }}</td>
                  </tr>
                }
              </tbody>
            </table>
          </div>

          <!-- Pagination -->
          @if (getTotalPages() > 1) {
            <nav aria-label="Row pagination">
              <ul class="pagination justify-content-center mb-0 mt-3">
                <li class="page-item" [class.disabled]="currentPage === 1">
                  <button class="page-link" (click)="previousPage()" [disabled]="currentPage === 1">Previous</button>
                </li>
                <li class="page-item active">
                  <span class="page-link">{{ currentPage }} of {{ getTotalPages() }}</span>
                </li>
                <li class="page-item" [class.disabled]="currentPage === getTotalPages()">
                  <button class="page-link" (click)="nextPage()" [disabled]="currentPage === getTotalPages()">Next</button>
                </li>
              </ul>
            </nav>
          }
        }
      </div>
    </div>
  }
</main>

